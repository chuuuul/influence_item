{
  "name": "Master Automation Pipeline - PRD Complete Implementation",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 7 * * *"
            }
          ]
        }
      },
      "id": "daily-master-cron",
      "name": "Daily Master Cron (7 AM)",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [300, 300]
    },
    {
      "parameters": {
        "jsCode": "// ë§ˆìŠ¤í„° íŒŒì´í”„ë¼ì¸ ì´ˆê¸°í™”\nconst pipelineStart = {\n  session_id: `master_${Date.now()}`,\n  start_time: new Date().toISOString(),\n  prd_version: '1.0',\n  pipeline_type: 'complete_automation',\n  steps_completed: [],\n  \n  // PRD ìš”êµ¬ì‚¬í•­ ì¶”ì \n  prd_requirements: {\n    '5.2_orchestration': 'n8nì„ ì§€íœ˜ìë¡œ ì‚¬ìš©í•˜ì—¬ 24/7 ìë™í™”',\n    '5.2_pipeline': 'ë§¤ì¼ 7ì‹œ Cron â†’ Sheets â†’ RSS â†’ ë¶„ì„ â†’ Slack',\n    '3.1_ai_pipeline': 'AI 2-Pass íŒŒì´í”„ë¼ì¸ ì™„ì „ êµ¬í˜„'\n  }\n};\n\nconsole.log('ğŸš€ PRD ë§ˆìŠ¤í„° ìë™í™” íŒŒì´í”„ë¼ì¸ ì‹œì‘:', pipelineStart.session_id);\n\nreturn [{ json: pipelineStart }];"
      },
      "id": "initialize-master-pipeline",
      "name": "Initialize Master Pipeline",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 300]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "resource": "sheet",
        "operation": "read",
        "documentId": {
          "__rl": true,
          "value": "{{ $env.GOOGLE_SHEETS_SPREADSHEET_ID }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Channel List",
          "mode": "name"
        },
        "options": {
          "range": "A:E"
        }
      },
      "id": "step1-read-channels",
      "name": "Step 1: Read Channel List",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [700, 300]
    },
    {
      "parameters": {
        "jsCode": "// ì±„ë„ ëª©ë¡ ì²˜ë¦¬ ë° RSS URL ìƒì„±\nconst channelData = $input.all();\nconst masterData = $('Initialize Master Pipeline').item.json;\nconst activeChannels = [];\n\nfor (const row of channelData) {\n  const channelId = row.json.channel_id;\n  const channelName = row.json.channel_name;\n  const status = row.json.status;\n  const channelType = row.json.channel_type;\n  const celebrityName = row.json.celebrity_name;\n  \n  if (status === 'active' && channelId) {\n    activeChannels.push({\n      channel_id: channelId,\n      channel_name: channelName,\n      channel_type: channelType,\n      celebrity_name: celebrityName,\n      rss_url: `https://www.youtube.com/feeds/videos.xml?channel_id=${channelId}`\n    });\n  }\n}\n\nconst result = {\n  ...masterData,\n  steps_completed: ['sheets_read'],\n  active_channels: activeChannels,\n  channels_count: activeChannels.length,\n  next_step: 'rss_collection'\n};\n\nconsole.log(`ğŸ“‹ í™œì„± ì±„ë„ ${activeChannels.length}ê°œ ë¡œë“œ ì™„ë£Œ`);\n\nreturn [{ json: result }];"
      },
      "id": "process-channels",
      "name": "Process Channel Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.RSS_AUTOMATION_API_URL || 'http://localhost:5002' }}/collect-rss",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "channels",
              "value": "={{ JSON.stringify($json.active_channels) }}"
            },
            {
              "name": "session_id",
              "value": "={{ $json.session_id }}"
            },
            {
              "name": "exclude_shorts",
              "value": "true"
            },
            {
              "name": "days_back",
              "value": "1"
            }
          ]
        },
        "options": {
          "timeout": 60000
        }
      },
      "id": "step2-rss-collection",
      "name": "Step 2: RSS Feed Collection",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1100, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-new-videos",
              "leftValue": "={{ $json.new_videos && $json.new_videos.length }}",
              "rightValue": "0",
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-new-videos",
      "name": "Check If New Videos Found",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1300, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/analyze/batch",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "videos",
              "value": "={{ JSON.stringify($json.new_videos) }}"
            },
            {
              "name": "session_id",
              "value": "={{ $('Process Channel Data').item.json.session_id }}"
            },
            {
              "name": "analysis_type",
              "value": "full_pipeline"
            },
            {
              "name": "prd_compliant",
              "value": "true"
            }
          ]
        },
        "options": {
          "timeout": 600000
        }
      },
      "id": "step3-ai-analysis",
      "name": "Step 3: AI 2-Pass Analysis Pipeline",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1500, 200]
    },
    {
      "parameters": {
        "jsCode": "// ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬ ë° í†µê³„ ìƒì„±\nconst analysisResult = $json;\nconst masterData = $('Process Channel Data').item.json;\n\nconst processedResult = {\n  ...masterData,\n  steps_completed: [...masterData.steps_completed, 'rss_collection', 'ai_analysis'],\n  analysis_result: analysisResult,\n  \n  // í†µê³„ ì •ë³´\n  statistics: {\n    videos_analyzed: analysisResult.total_videos || 0,\n    products_found: analysisResult.total_products || 0,\n    monetizable_products: analysisResult.monetizable_products || 0,\n    ppl_filtered: analysisResult.ppl_filtered || 0,\n    avg_score: analysisResult.average_score || 0\n  },\n  \n  // PRD íŒŒì´í”„ë¼ì¸ ì™„ë£Œ ìƒíƒœ\n  pipeline_status: {\n    whisper_analysis: 'completed',\n    gemini_first_pass: 'completed',\n    visual_analysis: 'completed',\n    gemini_second_pass: 'completed',\n    ppl_filtering: 'completed',\n    monetization_check: 'completed',\n    scoring: 'completed'\n  },\n  \n  next_step: 'notification'\n};\n\nconsole.log(`ğŸ¤– AI ë¶„ì„ ì™„ë£Œ: ${processedResult.statistics.products_found}ê°œ ì œí’ˆ, ${processedResult.statistics.monetizable_products}ê°œ ìˆ˜ìµí™” ê°€ëŠ¥`);\n\nreturn [{ json: processedResult }];"
      },
      "id": "process-analysis-results",
      "name": "Process Analysis Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1700, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.SLACK_WEBHOOK_URL }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "ğŸ‰ ë§ˆìŠ¤í„° ìë™í™” íŒŒì´í”„ë¼ì¸ ì™„ë£Œ!"
            },
            {
              "name": "blocks",
              "value": "={{ JSON.stringify([\n  {\n    \"type\": \"header\",\n    \"text\": {\n      \"type\": \"plain_text\",\n      \"text\": \"ğŸ‰ PRD ë§ˆìŠ¤í„° ìë™í™” íŒŒì´í”„ë¼ì¸ ì™„ë£Œ!\"\n    }\n  },\n  {\n    \"type\": \"section\",\n    \"fields\": [\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*ì‹¤í–‰ ì‹œê°„:*\\n\" + ((new Date() - new Date($json.start_time)) / 1000 / 60).toFixed(1) + \"ë¶„\"\n      },\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*ì²˜ë¦¬ëœ ì±„ë„:*\\n\" + $json.channels_count + \"ê°œ\"\n      },\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*ë¶„ì„ëœ ì˜ìƒ:*\\n\" + $json.statistics.videos_analyzed + \"ê°œ\"\n      },\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*ë°œê²¬ëœ ì œí’ˆ:*\\n\" + $json.statistics.products_found + \"ê°œ\"\n      },\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*ìˆ˜ìµí™” ê°€ëŠ¥:*\\n\" + $json.statistics.monetizable_products + \"ê°œ\"\n      },\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": \"*í‰ê·  ì ìˆ˜:*\\n\" + $json.statistics.avg_score + \"ì \"\n      }\n    ]\n  },\n  {\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": \"ğŸ“‹ *PRD íŒŒì´í”„ë¼ì¸ ë‹¨ê³„:*\\nâœ… Google Sheets ì±„ë„ ì½ê¸°\\nâœ… RSS í”¼ë“œ ìˆ˜ì§‘\\nâœ… Whisper ìŒì„± ë¶„ì„\\nâœ… Gemini 1ì°¨ íƒìƒ‰\\nâœ… ì‹œê° ë¶„ì„ (OCR+Object)\\nâœ… Gemini 2ì°¨ ì¢…í•©\\nâœ… PPL í•„í„°ë§\\nâœ… ì¿ íŒ¡ ìˆ˜ìµí™” ê²€ì¦\\nâœ… ë§¤ë ¥ë„ ìŠ¤ì½”ì–´ë§\"\n    }\n  },\n  {\n    \"type\": \"divider\"\n  },\n  {\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": \"ğŸ¯ *ë‹¤ìŒ ë‹¨ê³„:* ê´€ë¦¬ ëŒ€ì‹œë³´ë“œì—ì„œ í›„ë³´ ê²€í†  ë° ìŠ¹ì¸\\nğŸ“Š <https://docs.google.com/spreadsheets/d/\" + $env.GOOGLE_SHEETS_SPREADSHEET_ID + \"|Google Sheetsì—ì„œ ê²°ê³¼ í™•ì¸>\"\n    }\n  },\n  {\n    \"type\": \"context\",\n    \"elements\": [\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": \"ì™„ë£Œ ì‹œê°„: \" + new Date().toLocaleString('ko-KR') + \" | ì„¸ì…˜: \" + $json.session_id + \" | ì‹œìŠ¤í…œ: n8n ë§ˆìŠ¤í„° ìë™í™”\"\n      }\n    ]\n  }\n]) }}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "step4-final-notification",
      "name": "Step 4: Final Success Notification",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1900, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.SLACK_WEBHOOK_URL }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "ğŸ˜´ ì¼ì¼ ìˆ˜ì§‘ ì™„ë£Œ - ìƒˆë¡œìš´ ì˜ìƒ ì—†ìŒ"
            },
            {
              "name": "blocks",
              "value": "={{ JSON.stringify([\n  {\n    \"type\": \"header\",\n    \"text\": {\n      \"type\": \"plain_text\",\n      \"text\": \"ğŸ˜´ ì¼ì¼ ìë™í™” ì™„ë£Œ - ì‹ ê·œ ì½˜í…ì¸  ì—†ìŒ\"\n    }\n  },\n  {\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": \"ğŸ“Š *ì²˜ë¦¬ ê²°ê³¼:*\\nâ€¢ ì±„ë„ ìˆ˜: \" + $('Process Channel Data').item.json.channels_count + \"ê°œ\\nâ€¢ RSS í”¼ë“œ í™•ì¸: ì™„ë£Œ\\nâ€¢ ì‹ ê·œ ì˜ìƒ: 0ê°œ\\n\\nğŸ’¡ ì§€ë‚œ 24ì‹œê°„ ë‚´ ìƒˆë¡œìš´ ì˜ìƒì´ ì—…ë¡œë“œë˜ì§€ ì•Šì•˜ê±°ë‚˜, ì´ë¯¸ ë¶„ì„ì´ ì™„ë£Œëœ ì˜ìƒë“¤ì…ë‹ˆë‹¤.\"\n    }\n  },\n  {\n    \"type\": \"context\",\n    \"elements\": [\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": \"ì™„ë£Œ ì‹œê°„: \" + new Date().toLocaleString('ko-KR') + \" | ì„¸ì…˜: \" + $('Process Channel Data').item.json.session_id + \" | ë‹¤ìŒ ì‹¤í–‰: ë‚´ì¼ ì˜¤ì „ 7ì‹œ\"\n      }\n    ]\n  }\n]) }}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "no-videos-notification",
      "name": "No New Videos Notification",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1500, 400]
    },
    {
      "parameters": {
        "jsCode": "// ì—ëŸ¬ ì²˜ë¦¬ ë° ë³µêµ¬ ì‹œë„\nconst error = $input.all()[0];\nconst masterData = $('Process Channel Data').item.json;\n\nconst errorData = {\n  session_id: masterData.session_id,\n  error_time: new Date().toISOString(),\n  error_step: 'pipeline_execution',\n  error_message: error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜',\n  error_details: JSON.stringify(error, null, 2),\n  execution_time: ((new Date() - new Date(masterData.start_time)) / 1000).toFixed(1),\n  recovery_attempted: false\n};\n\nconsole.error('ë§ˆìŠ¤í„° íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜:', errorData);\n\nreturn [{ json: errorData }];"
      },
      "id": "handle-pipeline-error",
      "name": "Handle Pipeline Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 500]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.SLACK_WEBHOOK_URL }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "ğŸš¨ ë§ˆìŠ¤í„° ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜"
            },
            {
              "name": "blocks",
              "value": "={{ JSON.stringify([\n  {\n    \"type\": \"header\",\n    \"text\": {\n      \"type\": \"plain_text\",\n      \"text\": \"ğŸš¨ ë§ˆìŠ¤í„° ìë™í™” íŒŒì´í”„ë¼ì¸ ì˜¤ë¥˜\"\n    }\n  },\n  {\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": \"*ì˜¤ë¥˜ ë‚´ìš©:*\\n```\" + $json.error_message + \"```\\n\\n*ë°œìƒ ë‹¨ê³„:* \" + $json.error_step + \"\\n*ì„¸ì…˜ ID:* \" + $json.session_id + \"\\n*ë°œìƒ ì‹œê°„:* \" + new Date($json.error_time).toLocaleString('ko-KR')\"\n    }\n  },\n  {\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": \"ğŸ”§ *ê¸´ê¸‰ ì¡°ì¹˜ í•„ìš”:*\\nâ€¢ API ì„œë²„ ìƒíƒœ í™•ì¸\\nâ€¢ í™˜ê²½ë³€ìˆ˜ ì„¤ì • ê²€í† \\nâ€¢ ë¡œê·¸ íŒŒì¼ ë¶„ì„\\nâ€¢ ì‹œìŠ¤í…œ ì¬ì‹œì‘ ê³ ë ¤\"\n    }\n  },\n  {\n    \"type\": \"context\",\n    \"elements\": [\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": \"ìš°ì„ ìˆœìœ„: ë†’ìŒ | 24/7 ìë™í™” ì¤‘ë‹¨ë¨ | ì¦‰ì‹œ í™•ì¸ í•„ìš”\"\n      }\n    ]\n  }\n]) }}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "error-notification",
      "name": "Send Error Notification",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1100, 500]
    }
  ],
  "connections": {
    "Daily Master Cron (7 AM)": {
      "main": [
        [
          {
            "node": "Initialize Master Pipeline",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Initialize Master Pipeline": {
      "main": [
        [
          {
            "node": "Step 1: Read Channel List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 1: Read Channel List": {
      "main": [
        [
          {
            "node": "Process Channel Data",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Handle Pipeline Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Channel Data": {
      "main": [
        [
          {
            "node": "Step 2: RSS Feed Collection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 2: RSS Feed Collection": {
      "main": [
        [
          {
            "node": "Check If New Videos Found",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Handle Pipeline Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check If New Videos Found": {
      "main": [
        [
          {
            "node": "Step 3: AI 2-Pass Analysis Pipeline",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No New Videos Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 3: AI 2-Pass Analysis Pipeline": {
      "main": [
        [
          {
            "node": "Process Analysis Results",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Handle Pipeline Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Analysis Results": {
      "main": [
        [
          {
            "node": "Step 4: Final Success Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Pipeline Error": {
      "main": [
        [
          {
            "node": "Send Error Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "createdAt": "2025-06-25T00:00:00.000Z",
  "updatedAt": "2025-06-25T00:00:00.000Z",
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": {
      "id": "error-master-workflow"
    }
  },
  "staticData": {},
  "tags": ["prd", "master", "automation", "production"],
  "meta": {
    "templateCredsSetupCompleted": true,
    "prd_compliant": true,
    "version": "1.0"
  }
}