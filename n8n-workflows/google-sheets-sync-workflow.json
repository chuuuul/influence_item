{
  "name": "Google Sheets Real-time Sync Workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "sheets-webhook",
        "options": {
          "noResponseBody": false
        }
      },
      "id": "sheets-webhook",
      "name": "Google Sheets Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        300,
        300
      ],
      "webhookId": "google-sheets-changes"
    },
    {
      "parameters": {
        "jsCode": "// Google Sheets Webhook ë°ì´í„° íŒŒì‹±\nconst webhookData = $json;\n\nconsole.log('Google Sheets ë³€ê²½ì‚¬í•­ ê°ì§€:', webhookData);\n\n// Webhook ë°ì´í„° êµ¬ì¡° íŒŒì‹±\nconst changeData = {\n  eventType: webhookData.eventType || 'unknown',\n  spreadsheetId: webhookData.spreadsheetId,\n  sheetId: webhookData.sheetId,\n  range: webhookData.range,\n  changeType: webhookData.changeType || 'edit',\n  timestamp: new Date().toISOString(),\n  rawData: webhookData\n};\n\n// ì±„ë„ ëª©ë¡ ì‹œíŠ¸ ë³€ê²½ì¸ì§€ í™•ì¸\nconst isChannelListChange = changeData.spreadsheetId === $env.GOOGLE_SHEETS_CHANNEL_LIST_ID;\n\nreturn [{\n  json: {\n    ...changeData,\n    isChannelListChange: isChannelListChange,\n    needsSync: isChannelListChange\n  }\n}];"
      },
      "id": "parse-webhook-data",
      "name": "Parse Webhook Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        500,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "is-channel-list",
              "leftValue": "={{ $json.isChannelListChange }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-channel-list",
      "name": "Check Channel List Change",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        700,
        300
      ]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "resource": "sheet",
        "operation": "read",
        "documentId": {
          "__rl": true,
          "value": "{{$env.GOOGLE_SHEETS_CHANNEL_LIST_ID}}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "ì±„ë„ëª©ë¡",
          "mode": "name"
        },
        "options": {
          "range": "A:D",
          "valueRenderMode": "FORMATTED_VALUE"
        }
      },
      "id": "read-updated-channels",
      "name": "Read Updated Channel List",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        900,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// ì—…ë°ì´íŠ¸ëœ ì±„ë„ ëª©ë¡ ì²˜ë¦¬ ë° ë³€ê²½ì‚¬í•­ íƒì§€\nconst channels = [];\nconst inputData = $input.all();\nconst webhookData = $('Parse Webhook Data').item.json;\n\n// í˜„ì¬ ì‹œê°„\nconst syncTime = new Date().toISOString();\n\n// ì²« ë²ˆì§¸ í–‰ì€ í—¤ë”ì´ë¯€ë¡œ ì œì™¸\nfor (let i = 1; i < inputData.length; i++) {\n  const row = inputData[i].json;\n  \n  // ì±„ë„ëª…, RSS URL, íƒ€ì…, ì—°ì˜ˆì¸ ì´ë¦„ ì¶”ì¶œ\n  if (row.A && row.B) { // ì±„ë„ëª…ê³¼ RSS URLì´ ìˆëŠ” ê²½ìš°ë§Œ\n    channels.push({\n      channelName: row.A,\n      rssUrl: row.B,\n      channelType: row.C || 'personal',\n      celebrityNames: row.D ? row.D.split(',').map(name => name.trim()) : [],\n      lastUpdated: syncTime\n    });\n  }\n}\n\nconsole.log(`ì±„ë„ ëª©ë¡ ë™ê¸°í™”: ${channels.length}ê°œ ì±„ë„ ì—…ë°ì´íŠ¸ë¨`);\n\n// ë™ê¸°í™” ê²°ê³¼ ë°ì´í„° êµ¬ì„±\nconst syncResult = {\n  syncTime: syncTime,\n  totalChannels: channels.length,\n  changeEvent: webhookData,\n  channels: channels,\n  syncStatus: 'completed'\n};\n\nreturn [{ json: syncResult }];"
      },
      "id": "process-channel-sync",
      "name": "Process Channel Sync",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        200
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.PYTHON_ANALYSIS_ENDPOINT }}/sync-channels",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.ANALYSIS_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "channels",
              "value": "={{ JSON.stringify($json.channels) }}"
            },
            {
              "name": "sync_time",
              "value": "={{ $json.syncTime }}"
            },
            {
              "name": "total_channels",
              "value": "={{ $json.totalChannels }}"
            }
          ]
        },
        "options": {
          "timeout": 15000
        }
      },
      "id": "update-python-channels",
      "name": "Update Python System Channels",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1300,
        200
      ]
    },
    {
      "parameters": {
        "channel": "{{ $env.SLACK_CHANNEL }}",
        "text": "ğŸ“‹ ì±„ë„ ëª©ë¡ ìë™ ë™ê¸°í™” ì™„ë£Œ\\n\\nğŸ“Š ë™ê¸°í™” ê²°ê³¼:\\n- ì´ ì±„ë„ ìˆ˜: {{ $json.totalChannels }}ê°œ\\n- ë™ê¸°í™” ì‹œê°„: {{ $json.syncTime }}\\n- ë³€ê²½ ë²”ìœ„: {{ $('Parse Webhook Data').item.json.range }}\\n\\nâœ… Python ì‹œìŠ¤í…œê³¼ ë™ê¸°í™” ì™„ë£Œ",
        "otherOptions": {}
      },
      "id": "notify-sync-success",
      "name": "Notify Sync Success",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [
        1500,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// ì±„ë„ ëª©ë¡ ë³€ê²½ì´ ì•„ë‹Œ ê²½ìš° ë¡œê¹…\nconst webhookData = $json;\n\nconsole.log('ë¹„ì±„ë„ ëª©ë¡ ì‹œíŠ¸ ë³€ê²½ì‚¬í•­ ê°ì§€:', webhookData.spreadsheetId);\n\nreturn [{\n  json: {\n    message: 'ì±„ë„ ëª©ë¡ì´ ì•„ë‹Œ ì‹œíŠ¸ ë³€ê²½ì‚¬í•­ ê°ì§€ë¨',\n    spreadsheetId: webhookData.spreadsheetId,\n    action: 'ignored',\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "log-other-changes",
      "name": "Log Other Sheet Changes",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹…\nconst error = $json;\nconst webhookData = $('Parse Webhook Data').item.json;\n\nconsole.error('ì±„ë„ ë™ê¸°í™” ì‹¤íŒ¨:', error);\n\nreturn [{\n  json: {\n    error: error.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜',\n    webhookData: webhookData,\n    errorTime: new Date().toISOString(),\n    status: 'sync_failed'\n  }\n}];"
      },
      "id": "handle-sync-error",
      "name": "Handle Sync Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1300,
        400
      ]
    },
    {
      "parameters": {
        "channel": "{{ $env.SLACK_CHANNEL }}",
        "text": "âŒ ì±„ë„ ëª©ë¡ ë™ê¸°í™” ì‹¤íŒ¨\\n\\nğŸ’¥ ì—ëŸ¬ ë‚´ìš©:\\n{{ $json.error }}\\n\\nâ° ë°œìƒ ì‹œê°„: {{ $json.errorTime }}\\n\\nğŸ”§ ìš´ì˜ì í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.",
        "otherOptions": {}
      },
      "id": "notify-sync-error",
      "name": "Notify Sync Error",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [
        1500,
        400
      ]
    }
  ],
  "connections": {
    "Google Sheets Webhook": {
      "main": [
        [
          {
            "node": "Parse Webhook Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Webhook Data": {
      "main": [
        [
          {
            "node": "Check Channel List Change",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Channel List Change": {
      "main": [
        [
          {
            "node": "Read Updated Channel List",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Other Sheet Changes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Updated Channel List": {
      "main": [
        [
          {
            "node": "Process Channel Sync",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Channel Sync": {
      "main": [
        [
          {
            "node": "Update Python System Channels",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Python System Channels": {
      "main": [
        [
          {
            "node": "Notify Sync Success",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Handle Sync Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Sync Error": {
      "main": [
        [
          {
            "node": "Notify Sync Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-06-23T21:48:00.000Z",
  "updatedAt": "2025-06-23T21:48:00.000Z",
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": {
      "id": "error-workflow"
    }
  },
  "staticData": {},
  "tags": ["google-sheets", "sync", "realtime", "channels"]
}