{
  "name": "03. AI Analysis Pipeline",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "trigger-ai-analysis",
        "options": {
          "noResponseBody": false
        }
      },
      "id": "analysis-trigger",
      "name": "AI Analysis Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [300, 300],
      "webhookId": "ai-analysis-trigger"
    },
    {
      "parameters": {
        "jsCode": "// AI ë¶„ì„ íŒŒë¼ë¯¸í„° ì„¤ì • ë° ê²€ì¦\nconst triggerData = $input.all()[0].json;\n\n// í•„ìˆ˜ íŒŒë¼ë¯¸í„° ê²€ì¦\nif (!triggerData.video_url) {\n  throw new Error('video_url is required');\n}\n\n// ë¶„ì„ ì„¤ì •\nconst analysisParams = {\n  video_url: triggerData.video_url,\n  video_id: triggerData.video_id || extractVideoId(triggerData.video_url),\n  channel_info: triggerData.channel_info || {},\n  priority: triggerData.priority || 'normal',\n  analysis_type: triggerData.analysis_type || 'full', // full, quick, audio_only\n  session_id: `analysis_${Date.now()}`,\n  start_time: new Date().toISOString(),\n  \n  // AI 2-Pass íŒŒì´í”„ë¼ì¸ ì„¤ì •\n  whisper_model: 'small', // PRD ìš”êµ¬ì‚¬í•­: Whisper small ëª¨ë¸\n  gemini_model: '2.5-flash', // PRD ìš”êµ¬ì‚¬í•­: Gemini 2.5 Flash\n  enable_ocr: true,\n  enable_object_detection: true,\n  enable_ppl_detection: true,\n  enable_monetization_check: true,\n  \n  // ì ìˆ˜ ê°€ì¤‘ì¹˜ (PRD ê³µì‹)\n  scoring_weights: {\n    sentiment_score: 0.50,\n    endorsement_score: 0.35,\n    influencer_score: 0.15\n  }\n};\n\n// ë¹„ë””ì˜¤ ID ì¶”ì¶œ í•¨ìˆ˜\nfunction extractVideoId(url) {\n  const match = url.match(/(?:youtube\\.com\\/watch\\?v=|youtu\\.be\\/)([a-zA-Z0-9_-]+)/);\n  return match ? match[1] : null;\n}\n\nconsole.log('AI ë¶„ì„ ì‹œì‘:', analysisParams);\n\nreturn [{ json: analysisParams }];"
      },
      "id": "setup-analysis-params",
      "name": "Setup Analysis Parameters",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/analyze/whisper",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "video_url",
              "value": "={{ $json.video_url }}"
            },
            {
              "name": "video_id",
              "value": "={{ $json.video_id }}"
            },
            {
              "name": "model",
              "value": "{{ $json.whisper_model }}"
            },
            {
              "name": "session_id",
              "value": "={{ $json.session_id }}"
            }
          ]
        },
        "options": {
          "timeout": 300000
        }
      },
      "id": "step1-whisper-analysis",
      "name": "Step 1: Whisper Audio Analysis",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [700, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/analyze/gemini-first-pass",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "transcript",
              "value": "={{ JSON.stringify($json.transcript) }}"
            },
            {
              "name": "video_id",
              "value": "={{ $('Setup Analysis Parameters').item.json.video_id }}"
            },
            {
              "name": "session_id",
              "value": "={{ $('Setup Analysis Parameters').item.json.session_id }}"
            },
            {
              "name": "model",
              "value": "{{ $('Setup Analysis Parameters').item.json.gemini_model }}"
            }
          ]
        },
        "options": {
          "timeout": 120000
        }
      },
      "id": "step2-gemini-first-pass",
      "name": "Step 2: Gemini First Pass (íƒìƒ‰)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-candidate-segments",
              "leftValue": "={{ $json.candidate_segments && $json.candidate_segments.length }}",
              "rightValue": "0",
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-candidate-segments",
      "name": "Check If Candidate Segments Found",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1100, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/analyze/visual",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "video_url",
              "value": "={{ $('Setup Analysis Parameters').item.json.video_url }}"
            },
            {
              "name": "candidate_segments",
              "value": "={{ JSON.stringify($json.candidate_segments) }}"
            },
            {
              "name": "session_id",
              "value": "={{ $('Setup Analysis Parameters').item.json.session_id }}"
            },
            {
              "name": "enable_ocr",
              "value": "{{ $('Setup Analysis Parameters').item.json.enable_ocr }}"
            },
            {
              "name": "enable_object_detection",
              "value": "{{ $('Setup Analysis Parameters').item.json.enable_object_detection }}"
            }
          ]
        },
        "options": {
          "timeout": 300000
        }
      },
      "id": "step3-visual-analysis",
      "name": "Step 3: Visual Analysis (OCR + Object Detection)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1300, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/analyze/gemini-second-pass",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "audio_data",
              "value": "={{ JSON.stringify($('Step 2: Gemini First Pass (íƒìƒ‰)').item.json) }}"
            },
            {
              "name": "visual_data",
              "value": "={{ JSON.stringify($json) }}"
            },
            {
              "name": "video_id",
              "value": "={{ $('Setup Analysis Parameters').item.json.video_id }}"
            },
            {
              "name": "session_id",
              "value": "={{ $('Setup Analysis Parameters').item.json.session_id }}"
            },
            {
              "name": "channel_info",
              "value": "={{ JSON.stringify($('Setup Analysis Parameters').item.json.channel_info) }}"
            }
          ]
        },
        "options": {
          "timeout": 120000
        }
      },
      "id": "step4-gemini-second-pass",
      "name": "Step 4: Gemini Second Pass (ì¢…í•©)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1500, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/analyze/ppl-filter",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "analysis_result",
              "value": "={{ JSON.stringify($json) }}"
            },
            {
              "name": "session_id",
              "value": "={{ $('Setup Analysis Parameters').item.json.session_id }}"
            }
          ]
        },
        "options": {
          "timeout": 60000
        }
      },
      "id": "step5-ppl-filtering",
      "name": "Step 5: PPL Content Filtering",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1700, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/analyze/monetization",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "products",
              "value": "={{ JSON.stringify($json.products || []) }}"
            },
            {
              "name": "session_id",
              "value": "={{ $('Setup Analysis Parameters').item.json.session_id }}"
            }
          ]
        },
        "options": {
          "timeout": 60000
        }
      },
      "id": "step6-monetization-check",
      "name": "Step 6: Monetization Verification (Coupang)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1900, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/analyze/scoring",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "analysis_data",
              "value": "={{ JSON.stringify($json) }}"
            },
            {
              "name": "scoring_weights",
              "value": "={{ JSON.stringify($('Setup Analysis Parameters').item.json.scoring_weights) }}"
            },
            {
              "name": "session_id",
              "value": "={{ $('Setup Analysis Parameters').item.json.session_id }}"
            }
          ]
        },
        "options": {
          "timeout": 60000
        }
      },
      "id": "step7-scoring",
      "name": "Step 7: Attractiveness Scoring",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2100, 200]
    },
    {
      "parameters": {
        "jsCode": "// ìµœì¢… ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬ ë° ì •ë¦¬\nconst finalResult = $json;\nconst setupData = $('Setup Analysis Parameters').item.json;\n\n// ë¶„ì„ ì™„ë£Œ ë°ì´í„° êµ¬ì„±\nconst processedResult = {\n  session_id: setupData.session_id,\n  video_url: setupData.video_url,\n  video_id: setupData.video_id,\n  channel_info: setupData.channel_info,\n  start_time: setupData.start_time,\n  end_time: new Date().toISOString(),\n  execution_time: ((new Date() - new Date(setupData.start_time)) / 1000).toFixed(1),\n  \n  // ë¶„ì„ ê²°ê³¼\n  analysis_result: finalResult,\n  total_products: finalResult.products ? finalResult.products.length : 0,\n  monetizable_products: finalResult.monetizable_products ? finalResult.monetizable_products.length : 0,\n  filtered_products: finalResult.filtered_products ? finalResult.filtered_products.length : 0,\n  \n  // ìƒíƒœ ì •ë³´\n  status: 'analysis_complete',\n  success: true,\n  \n  // íƒ€ì„ìŠ¤íƒ¬í”„\n  completed_at: new Date().toISOString()\n};\n\nconsole.log(`AI ë¶„ì„ ì™„ë£Œ: ${processedResult.total_products}ê°œ ì œí’ˆ ë°œê²¬, ${processedResult.monetizable_products}ê°œ ìˆ˜ìµí™” ê°€ëŠ¥`);\n\nreturn [{ json: processedResult }];"
      },
      "id": "finalize-analysis",
      "name": "Finalize Analysis Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2300, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.SLACK_WEBHOOK_URL }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "ğŸ¤– AI ë¶„ì„ ì™„ë£Œ!"
            },
            {
              "name": "blocks",
              "value": "={{ JSON.stringify([{\"type\": \"header\", \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸ¤– AI ë¶„ì„ ì™„ë£Œ!\"}}, {\"type\": \"section\", \"fields\": [{\"type\": \"mrkdwn\", \"text\": \"*ì˜ìƒ:*\\n<\" + $json.video_url + \"|\" + ($json.channel_info.channel_name || 'Unknown') + \">\"}, {\"type\": \"mrkdwn\", \"text\": \"*ë°œê²¬ëœ ì œí’ˆ:*\\n\" + $json.total_products + \"ê°œ\"}, {\"type\": \"mrkdwn\", \"text\": \"*ìˆ˜ìµí™” ê°€ëŠ¥:*\\n\" + $json.monetizable_products + \"ê°œ\"}, {\"type\": \"mrkdwn\", \"text\": \"*ì‹¤í–‰ ì‹œê°„:*\\n\" + $json.execution_time + \"ì´ˆ\"}]}, {\"type\": \"section\", \"text\": {\"type\": \"mrkdwn\", \"text\": \"ğŸ“Š *ë¶„ì„ íŒŒì´í”„ë¼ì¸:*\\nâœ… Whisper ìŒì„± ë¶„ì„\\nâœ… Gemini 1ì°¨ íƒìƒ‰\\nâœ… ì‹œê° ë¶„ì„ (OCR + Object)\\nâœ… Gemini 2ì°¨ ì¢…í•©\\nâœ… PPL í•„í„°ë§\\nâœ… ì¿ íŒ¡ ìˆ˜ìµí™” ê²€ì¦\\nâœ… ë§¤ë ¥ë„ ìŠ¤ì½”ì–´ë§\"}}, {\"type\": \"context\", \"elements\": [{\"type\": \"mrkdwn\", \"text\": \"ì™„ë£Œ: \" + new Date().toLocaleString('ko-KR') + \" | ì„¸ì…˜: \" + $json.session_id}]}]) }}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "notify-analysis-complete",
      "name": "Notify Analysis Complete",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2500, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.SLACK_WEBHOOK_URL }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "ğŸ˜” AI ë¶„ì„ ì™„ë£Œ - ì œí’ˆ í›„ë³´ ì—†ìŒ"
            },
            {
              "name": "blocks",
              "value": "={{ JSON.stringify([{\"type\": \"header\", \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸ˜” AI ë¶„ì„ ì™„ë£Œ\"}}, {\"type\": \"section\", \"text\": {\"type\": \"mrkdwn\", \"text\": \"*ê²°ê³¼:* ì œí’ˆ ì¶”ì²œ êµ¬ê°„ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\\n\\n*ë¶„ì„ëœ ì˜ìƒ:*\\n<\" + $('Setup Analysis Parameters').item.json.video_url + \"|\" + ($('Setup Analysis Parameters').item.json.channel_info.channel_name || 'Unknown') + \">\\n\\n*ì„¸ì…˜ ID:* \" + $('Setup Analysis Parameters').item.json.session_id}}, {\"type\": \"section\", \"text\": {\"type\": \"mrkdwn\", \"text\": \"ğŸ’¡ *ê°€ëŠ¥í•œ ì›ì¸:*\\nâ€¢ ì œí’ˆ ì–¸ê¸‰ì´ ì—†ëŠ” ì˜ìƒ\\nâ€¢ ì¶”ì²œ ë§¥ë½ì´ ëª…í™•í•˜ì§€ ì•ŠìŒ\\nâ€¢ ìŒì„± ì¸ì‹ í’ˆì§ˆ ë¬¸ì œ\"}}, {\"type\": \"context\", \"elements\": [{\"type\": \"mrkdwn\", \"text\": \"ì™„ë£Œ: \" + new Date().toLocaleString('ko-KR') + \" | ì‹œìŠ¤í…œ: AI ë¶„ì„ íŒŒì´í”„ë¼ì¸\"}]}]) }}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "notify-no-products",
      "name": "Notify No Products Found",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1300, 400]
    }
  ],
  "connections": {
    "AI Analysis Trigger": {
      "main": [
        [
          {
            "node": "Setup Analysis Parameters",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setup Analysis Parameters": {
      "main": [
        [
          {
            "node": "Step 1: Whisper Audio Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 1: Whisper Audio Analysis": {
      "main": [
        [
          {
            "node": "Step 2: Gemini First Pass (íƒìƒ‰)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 2: Gemini First Pass (íƒìƒ‰)": {
      "main": [
        [
          {
            "node": "Check If Candidate Segments Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check If Candidate Segments Found": {
      "main": [
        [
          {
            "node": "Step 3: Visual Analysis (OCR + Object Detection)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Notify No Products Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 3: Visual Analysis (OCR + Object Detection)": {
      "main": [
        [
          {
            "node": "Step 4: Gemini Second Pass (ì¢…í•©)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 4: Gemini Second Pass (ì¢…í•©)": {
      "main": [
        [
          {
            "node": "Step 5: PPL Content Filtering",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 5: PPL Content Filtering": {
      "main": [
        [
          {
            "node": "Step 6: Monetization Verification (Coupang)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 6: Monetization Verification (Coupang)": {
      "main": [
        [
          {
            "node": "Step 7: Attractiveness Scoring",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 7: Attractiveness Scoring": {
      "main": [
        [
          {
            "node": "Finalize Analysis Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Finalize Analysis Results": {
      "main": [
        [
          {
            "node": "Notify Analysis Complete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "createdAt": "2025-06-25T07:00:00.000Z",
  "updatedAt": "2025-06-25T07:00:00.000Z",
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": {},
  "tags": []
}