{
  "name": "04. Historical Video Analysis",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "trigger-historical-analysis",
        "options": {
          "noResponseBody": false
        }
      },
      "id": "historical-trigger",
      "name": "Historical Analysis Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [300, 300],
      "webhookId": "historical-analysis-trigger"
    },
    {
      "parameters": {
        "jsCode": "// ê³¼ê±° ì˜ìƒ ë¶„ì„ íŒŒë¼ë¯¸í„° ì„¤ì •\nconst triggerData = $input.all()[0].json;\n\n// í•„ìˆ˜ íŒŒë¼ë¯¸í„° ê²€ì¦\nif (!triggerData.channel_id && !triggerData.channel_url) {\n  throw new Error('channel_id or channel_url is required');\n}\n\n// ë¶„ì„ ì„¤ì •\nconst analysisParams = {\n  channel_id: triggerData.channel_id,\n  channel_url: triggerData.channel_url,\n  channel_name: triggerData.channel_name || '',\n  celebrity_name: triggerData.celebrity_name || '',\n  \n  // ë¶„ì„ ê¸°ê°„ ì„¤ì •\n  days_back: triggerData.days_back || 30,\n  max_videos: triggerData.max_videos || 20,\n  start_date: triggerData.start_date || null,\n  end_date: triggerData.end_date || null,\n  \n  // í•„í„°ë§ ì˜µì…˜\n  exclude_shorts: triggerData.exclude_shorts !== false, // ê¸°ë³¸ê°’: true (PRD ìš”êµ¬ì‚¬í•­)\n  min_duration: triggerData.min_duration || 60, // ìµœì†Œ 1ë¶„\n  \n  // ì„¸ì…˜ ì •ë³´\n  session_id: `historical_${Date.now()}`,\n  start_time: new Date().toISOString(),\n  \n  // ë¶„ì„ ìš°ì„ ìˆœìœ„\n  priority: triggerData.priority || 'normal',\n  batch_size: triggerData.batch_size || 5 // ë™ì‹œ ë¶„ì„í•  ì˜ìƒ ìˆ˜\n};\n\nconsole.log('ê³¼ê±° ì˜ìƒ ë¶„ì„ ì‹œì‘:', analysisParams);\n\nreturn [{ json: analysisParams }];"
      },
      "id": "setup-historical-params",
      "name": "Setup Historical Analysis Parameters",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/scrape/channel-videos",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "channel_id",
              "value": "={{ $json.channel_id }}"
            },
            {
              "name": "channel_url",
              "value": "={{ $json.channel_url }}"
            },
            {
              "name": "days_back",
              "value": "={{ $json.days_back }}"
            },
            {
              "name": "max_videos",
              "value": "={{ $json.max_videos }}"
            },
            {
              "name": "exclude_shorts",
              "value": "={{ $json.exclude_shorts }}"
            },
            {
              "name": "min_duration",
              "value": "={{ $json.min_duration }}"
            },
            {
              "name": "session_id",
              "value": "={{ $json.session_id }}"
            }
          ]
        },
        "options": {
          "timeout": 300000
        }
      },
      "id": "scrape-channel-videos",
      "name": "Scrape Channel Videos (Playwright)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [700, 300]
    },
    {
      "parameters": {
        "jsCode": "// ìŠ¤í¬ë˜í•‘ ê²°ê³¼ ì²˜ë¦¬ ë° ë¶„ì„ ëŒ€ìƒ ì„ ì •\nconst scrapeResult = $json;\nconst setupData = $('Setup Historical Analysis Parameters').item.json;\n\n// ìŠ¤í¬ë˜í•‘ëœ ì˜ìƒ ëª©ë¡\nconst videos = scrapeResult.videos || [];\nconst totalVideos = videos.length;\n\n// ë¶„ì„í•  ì˜ìƒë“¤ í•„í„°ë§ ë° ìš°ì„ ìˆœìœ„ ì •ë ¬\nconst analysisTargets = videos\n  .filter(video => {\n    // ê¸°ë³¸ í•„í„°ë§\n    if (!video.video_id || !video.title) return false;\n    \n    // ì‡¼ì¸  ì œì™¸ (PRD ìš”êµ¬ì‚¬í•­)\n    if (setupData.exclude_shorts) {\n      const isShorts = video.title.toLowerCase().includes('#shorts') ||\n                      video.title.toLowerCase().includes('shorts') ||\n                      video.title.includes('ğŸ©³') ||\n                      (video.duration && video.duration < 60);\n      if (isShorts) return false;\n    }\n    \n    // ìµœì†Œ ê¸¸ì´ ì²´í¬\n    if (video.duration && video.duration < setupData.min_duration) {\n      return false;\n    }\n    \n    return true;\n  })\n  .sort((a, b) => {\n    // ìµœì‹  ì˜ìƒ ìš°ì„ , ì¡°íšŒìˆ˜ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬\n    const dateA = new Date(a.upload_date || 0);\n    const dateB = new Date(b.upload_date || 0);\n    if (dateA.getTime() !== dateB.getTime()) {\n      return dateB.getTime() - dateA.getTime();\n    }\n    return (b.view_count || 0) - (a.view_count || 0);\n  })\n  .slice(0, setupData.max_videos); // ìµœëŒ€ ê°œìˆ˜ ì œí•œ\n\n// ë°°ì¹˜ ì²˜ë¦¬ìš© ê·¸ë£¹ ìƒì„±\nconst batches = [];\nfor (let i = 0; i < analysisTargets.length; i += setupData.batch_size) {\n  batches.push(analysisTargets.slice(i, i + setupData.batch_size));\n}\n\nconst result = {\n  session_id: setupData.session_id,\n  channel_info: {\n    channel_id: setupData.channel_id,\n    channel_name: setupData.channel_name,\n    celebrity_name: setupData.celebrity_name\n  },\n  scrape_stats: {\n    total_found: totalVideos,\n    after_filtering: analysisTargets.length,\n    excluded_shorts: totalVideos - videos.filter(v => !v.title.toLowerCase().includes('shorts')).length,\n    batch_count: batches.length\n  },\n  analysis_targets: analysisTargets,\n  batches: batches,\n  start_time: setupData.start_time,\n  scrape_completed_at: new Date().toISOString()\n};\n\nconsole.log(`ì±„ë„ ìŠ¤í¬ë˜í•‘ ì™„ë£Œ: ${totalVideos}ê°œ ë°œê²¬, ${analysisTargets.length}ê°œ ë¶„ì„ ëŒ€ìƒ ì„ ì •`);\n\nreturn [{ json: result }];"
      },
      "id": "process-scrape-results",
      "name": "Process Scrape Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-videos",
              "leftValue": "={{ $json.analysis_targets && $json.analysis_targets.length }}",
              "rightValue": "0",
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-analysis-targets",
      "name": "Check If Videos to Analyze",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1100, 300]
    },
    {
      "parameters": {
        "jsCode": "// ë°°ì¹˜ë³„ ë¶„ì„ ìš”ì²­ ì¤€ë¹„\nconst data = $json;\nconst batches = data.batches || [];\nconst results = [];\n\n// ê° ë°°ì¹˜ë¥¼ ë¶„ì„ ìš”ì²­ìœ¼ë¡œ ë³€í™˜\nfor (let i = 0; i < batches.length; i++) {\n  const batch = batches[i];\n  \n  for (const video of batch) {\n    results.push({\n      video_url: `https://www.youtube.com/watch?v=${video.video_id}`,\n      video_id: video.video_id,\n      video_title: video.title,\n      video_duration: video.duration,\n      upload_date: video.upload_date,\n      view_count: video.view_count,\n      channel_info: data.channel_info,\n      session_id: data.session_id,\n      batch_index: i,\n      priority: 'batch',\n      analysis_type: 'full'\n    });\n  }\n}\n\nconsole.log(`${results.length}ê°œ ì˜ìƒ ë¶„ì„ ìš”ì²­ ì¤€ë¹„`);\n\nreturn results.map(item => ({ json: item }));"
      },
      "id": "prepare-batch-analysis",
      "name": "Prepare Batch Analysis Requests",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1300, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/analyze/video",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "video_url",
              "value": "={{ $json.video_url }}"
            },
            {
              "name": "video_id",
              "value": "={{ $json.video_id }}"
            },
            {
              "name": "channel_info",
              "value": "={{ JSON.stringify($json.channel_info) }}"
            },
            {
              "name": "priority",
              "value": "{{ $json.priority }}"
            },
            {
              "name": "analysis_type",
              "value": "{{ $json.analysis_type }}"
            },
            {
              "name": "session_id",
              "value": "={{ $json.session_id }}"
            },
            {
              "name": "metadata",
              "value": "={{ JSON.stringify({batch_index: $json.batch_index, video_title: $json.video_title, upload_date: $json.upload_date, view_count: $json.view_count}) }}"
            }
          ]
        },
        "options": {
          "timeout": 300000
        }
      },
      "id": "trigger-video-analysis",
      "name": "Trigger Individual Video Analysis",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1500, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.SLACK_WEBHOOK_URL }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "ğŸ“¹ ê³¼ê±° ì˜ìƒ ë¶„ì„ ì‹œì‘!"
            },
            {
              "name": "blocks",
              "value": "={{ JSON.stringify([{\"type\": \"header\", \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸ“¹ ê³¼ê±° ì˜ìƒ ë¶„ì„ ì‹œì‘!\"}}, {\"type\": \"section\", \"fields\": [{\"type\": \"mrkdwn\", \"text\": \"*ì±„ë„:*\\n\" + $json.channel_info.channel_name}, {\"type\": \"mrkdwn\", \"text\": \"*ì—°ì˜ˆì¸:*\\n\" + ($json.channel_info.celebrity_name || 'N/A')}, {\"type\": \"mrkdwn\", \"text\": \"*ë¶„ì„ ëŒ€ìƒ:*\\n\" + $json.analysis_targets.length + \"ê°œ ì˜ìƒ\"}, {\"type\": \"mrkdwn\", \"text\": \"*ë°°ì¹˜ ìˆ˜:*\\n\" + $json.scrape_stats.batch_count + \"ê°œ\"}]}, {\"type\": \"section\", \"text\": {\"type\": \"mrkdwn\", \"text\": \"ğŸ“Š *ìŠ¤í¬ë˜í•‘ ê²°ê³¼:*\\nâ€¢ ì´ ë°œê²¬: \" + $json.scrape_stats.total_found + \"ê°œ\\nâ€¢ í•„í„°ë§ í›„: \" + $json.scrape_stats.after_filtering + \"ê°œ\\nâ€¢ ì‡¼ì¸  ì œì™¸: \" + $json.scrape_stats.excluded_shorts + \"ê°œ\"}}, {\"type\": \"context\", \"elements\": [{\"type\": \"mrkdwn\", \"text\": \"ì‹œì‘: \" + new Date().toLocaleString('ko-KR') + \" | ì„¸ì…˜: \" + $json.session_id}]}]) }}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "notify-batch-start",
      "name": "Notify Batch Analysis Start",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1300, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.SLACK_WEBHOOK_URL }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "ğŸ˜” ê³¼ê±° ì˜ìƒ ë¶„ì„ - ë¶„ì„í•  ì˜ìƒ ì—†ìŒ"
            },
            {
              "name": "blocks",
              "value": "={{ JSON.stringify([{\"type\": \"header\", \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸ˜” ê³¼ê±° ì˜ìƒ ë¶„ì„ ì™„ë£Œ\"}}, {\"type\": \"section\", \"text\": {\"type\": \"mrkdwn\", \"text\": \"*ê²°ê³¼:* ë¶„ì„ ì¡°ê±´ì— ë§ëŠ” ì˜ìƒì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\\n\\n*ì±„ë„:* \" + $('Setup Historical Analysis Parameters').item.json.channel_name + \"\\n*ë¶„ì„ ê¸°ê°„:* \" + $('Setup Historical Analysis Parameters').item.json.days_back + \"ì¼\"}}, {\"type\": \"section\", \"text\": {\"type\": \"mrkdwn\", \"text\": \"ğŸ’¡ *ê°€ëŠ¥í•œ ì›ì¸:*\\nâ€¢ í•´ë‹¹ ê¸°ê°„ì— ì—…ë¡œë“œëœ ì˜ìƒ ì—†ìŒ\\nâ€¢ ëª¨ë“  ì˜ìƒì´ ì‡¼ì¸ ê±°ë‚˜ ë„ˆë¬´ ì§§ìŒ\\nâ€¢ ì±„ë„ ì ‘ê·¼ ê¶Œí•œ ë¬¸ì œ\"}}, {\"type\": \"context\", \"elements\": [{\"type\": \"mrkdwn\", \"text\": \"ì™„ë£Œ: \" + new Date().toLocaleString('ko-KR') + \" | ì„¸ì…˜: \" + $('Setup Historical Analysis Parameters').item.json.session_id}]}]) }}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "notify-no-videos",
      "name": "Notify No Videos to Analyze",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1100, 500]
    }
  ],
  "connections": {
    "Historical Analysis Trigger": {
      "main": [
        [
          {
            "node": "Setup Historical Analysis Parameters",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setup Historical Analysis Parameters": {
      "main": [
        [
          {
            "node": "Scrape Channel Videos (Playwright)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Scrape Channel Videos (Playwright)": {
      "main": [
        [
          {
            "node": "Process Scrape Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Scrape Results": {
      "main": [
        [
          {
            "node": "Check If Videos to Analyze",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check If Videos to Analyze": {
      "main": [
        [
          {
            "node": "Prepare Batch Analysis Requests",
            "type": "main",
            "index": 0
          },
          {
            "node": "Notify Batch Analysis Start",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Notify No Videos to Analyze",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Batch Analysis Requests": {
      "main": [
        [
          {
            "node": "Trigger Individual Video Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "createdAt": "2025-06-25T07:00:00.000Z",
  "updatedAt": "2025-06-25T07:00:00.000Z",
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": {},
  "tags": []
}