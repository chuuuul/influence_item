{
  "name": "Daily Video Collection Workflow",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "cronExpression": "0 7 * * *"
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "Daily 7AM Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        300,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// ì›Œí¬í”Œë¡œìš° ì‹œì‘ ë¡œê·¸\nconst startTime = new Date().toISOString();\nconsole.log(`[${startTime}] ìë™ ì˜ìƒ ìˆ˜ì§‘ ì›Œí¬í”Œë¡œìš° ì‹œì‘`);\n\n// ì›Œí¬í”Œë¡œìš° ìƒíƒœ ë°ì´í„° ì´ˆê¸°í™”\nconst workflowData = {\n  startTime: startTime,\n  totalChannels: 0,\n  totalVideos: 0,\n  newVideosFound: 0,\n  errors: []\n};\n\nreturn [{ json: workflowData }];"
      },
      "id": "workflow-init",
      "name": "Workflow Initialization",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        500,
        300
      ]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "resource": "sheet",
        "operation": "read",
        "documentId": {
          "__rl": true,
          "value": "{{$env.GOOGLE_SHEETS_CHANNEL_LIST_ID}}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "ì±„ë„ëª©ë¡",
          "mode": "name"
        },
        "options": {
          "range": "A:D",
          "valueRenderMode": "FORMATTED_VALUE"
        }
      },
      "id": "read-channels",
      "name": "Read Channel List",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        700,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Google Sheetsì—ì„œ ì½ì€ ì±„ë„ ë°ì´í„° ì²˜ë¦¬\nconst channels = [];\nconst inputData = $input.all();\n\n// ì²« ë²ˆì§¸ í–‰ì€ í—¤ë”ì´ë¯€ë¡œ ì œì™¸\nfor (let i = 1; i < inputData.length; i++) {\n  const row = inputData[i].json;\n  \n  // ì±„ë„ëª…, RSS URL, íƒ€ì…, ì—°ì˜ˆì¸ ì´ë¦„ ì¶”ì¶œ\n  if (row.A && row.B) { // ì±„ë„ëª…ê³¼ RSS URLì´ ìˆëŠ” ê²½ìš°ë§Œ\n    channels.push({\n      channelName: row.A,\n      rssUrl: row.B,\n      channelType: row.C || 'personal', // ê°œì¸ì±„ë„/ë¯¸ë””ì–´ì±„ë„\n      celebrityNames: row.D ? row.D.split(',').map(name => name.trim()) : []\n    });\n  }\n}\n\nconsole.log(`ì´ ${channels.length}ê°œ ì±„ë„ ë¡œë“œë¨`);\n\n// ê° ì±„ë„ì„ ê°œë³„ ì•„ì´í…œìœ¼ë¡œ ì¶œë ¥\nreturn channels.map(channel => ({ json: channel }));"
      },
      "id": "process-channels",
      "name": "Process Channel Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        300
      ]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "loop-channels",
      "name": "Loop Over Channels",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1100,
        300
      ]
    },
    {
      "parameters": {
        "url": "={{ $json.rssUrl }}",
        "options": {
          "fullResponse": false
        }
      },
      "id": "fetch-rss",
      "name": "Fetch RSS Feed",
      "type": "n8n-nodes-base.rssFeedRead",
      "typeVersion": 1,
      "position": [
        1300,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// RSS í”¼ë“œì—ì„œ ìƒˆ ì˜ìƒ í•„í„°ë§ ë° ë¶„ì„\nconst channelData = $('Loop Over Channels').item.json;\nconst rssItems = $input.all();\nconst currentTime = new Date();\nconst oneDayAgo = new Date(currentTime - 24 * 60 * 60 * 1000); // 24ì‹œê°„ ì „\n\nconst newVideos = [];\n\nfor (const item of rssItems) {\n  const video = item.json;\n  const publishDate = new Date(video.pubDate || video.published);\n  \n  // 24ì‹œê°„ ì´ë‚´ ì—…ë¡œë“œëœ ì˜ìƒë§Œ ì²˜ë¦¬\n  if (publishDate > oneDayAgo) {\n    // ë¯¸ë””ì–´ ì±„ë„ì˜ ê²½ìš° ì—°ì˜ˆì¸ ì´ë¦„ í•„í„°ë§\n    let shouldProcess = true;\n    \n    if (channelData.channelType === 'media' && channelData.celebrityNames.length > 0) {\n      shouldProcess = channelData.celebrityNames.some(name => \n        video.title.toLowerCase().includes(name.toLowerCase())\n      );\n    }\n    \n    if (shouldProcess) {\n      newVideos.push({\n        channelName: channelData.channelName,\n        channelType: channelData.channelType,\n        videoTitle: video.title,\n        videoUrl: video.link,\n        publishDate: video.pubDate || video.published,\n        description: video.description || '',\n        guid: video.guid\n      });\n    }\n  }\n}\n\nconsole.log(`${channelData.channelName}ì—ì„œ ${newVideos.length}ê°œ ìƒˆ ì˜ìƒ ë°œê²¬`);\n\nreturn newVideos.map(video => ({ json: video }));"
      },
      "id": "filter-new-videos",
      "name": "Filter New Videos",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1500,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-new-videos",
              "leftValue": "={{ $json.videoUrl }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isNotEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-new-videos",
      "name": "Check New Videos",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1700,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.PYTHON_ANALYSIS_ENDPOINT }}/analyze",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.ANALYSIS_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "video_url",
              "value": "={{ $json.videoUrl }}"
            },
            {
              "name": "channel_name",
              "value": "={{ $json.channelName }}"
            },
            {
              "name": "video_title",
              "value": "={{ $json.videoTitle }}"
            },
            {
              "name": "publish_date",
              "value": "={{ $json.publishDate }}"
            },
            {
              "name": "priority",
              "value": "high"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "trigger-analysis",
      "name": "Trigger Python Analysis",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1900,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// ë¶„ì„ íŠ¸ë¦¬ê±° ê²°ê³¼ ë¡œê¹…\nconst analysisResult = $json;\nconst videoData = $('Filter New Videos').item.json;\n\nconsole.log(`ë¶„ì„ ìš”ì²­ ì „ì†¡: ${videoData.videoTitle}`);\nconsole.log(`ë¶„ì„ ì‘ì—… ID: ${analysisResult.job_id}`);\n\n// ë£¨í”„ë¡œ ëŒì•„ê°€ê¸° ìœ„í•œ ë°ì´í„° êµ¬ì„±\nreturn [{\n  json: {\n    ...videoData,\n    analysisJobId: analysisResult.job_id,\n    analysisStatus: 'queued',\n    triggeredAt: new Date().toISOString()\n  }\n}];"
      },
      "id": "log-analysis",
      "name": "Log Analysis Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2100,
        200
      ]
    },
    {
      "parameters": {
        "channel": "{{ $env.SLACK_CHANNEL }}",
        "text": "ğŸ¬ ìƒˆ ì˜ìƒ ë¶„ì„ ì‹œì‘\\nì±„ë„: {{ $json.channelName }}\\nì œëª©: {{ $json.videoTitle }}\\nì‘ì—… ID: {{ $json.analysisJobId }}",
        "otherOptions": {}
      },
      "id": "notify-analysis-started",
      "name": "Notify Analysis Started",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [
        2300,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹…\nconst error = $json;\nconst videoData = $('Filter New Videos').item.json;\n\nconsole.error(`ë¶„ì„ ìš”ì²­ ì‹¤íŒ¨: ${videoData.videoTitle}`);\nconsole.error(`ì—ëŸ¬: ${error.message}`);\n\n// ì—ëŸ¬ ë°ì´í„° êµ¬ì„±\nreturn [{\n  json: {\n    ...videoData,\n    error: error.message,\n    errorTime: new Date().toISOString(),\n    status: 'failed'\n  }\n}];"
      },
      "id": "handle-analysis-error",
      "name": "Handle Analysis Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1900,
        400
      ]
    },
    {
      "parameters": {
        "channel": "{{ $env.SLACK_CHANNEL }}",
        "text": "âŒ ì˜ìƒ ë¶„ì„ ì‹¤íŒ¨\\nì±„ë„: {{ $json.channelName }}\\nì œëª©: {{ $json.videoTitle }}\\nì—ëŸ¬: {{ $json.error }}",
        "otherOptions": {}
      },
      "id": "notify-analysis-error",
      "name": "Notify Analysis Error",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [
        2100,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// ì›Œí¬í”Œë¡œìš° ì™„ë£Œ ì²˜ë¦¬\nconst allResults = $input.all();\nconst successCount = allResults.filter(item => item.json.analysisJobId).length;\nconst errorCount = allResults.filter(item => item.json.error).length;\nconst totalProcessed = successCount + errorCount;\n\nconst summary = {\n  workflowEndTime: new Date().toISOString(),\n  totalChannelsProcessed: $('Loop Over Channels').itemLists?.length || 0,\n  totalVideosAnalyzed: successCount,\n  totalErrors: errorCount,\n  totalProcessed: totalProcessed,\n  successRate: totalProcessed > 0 ? (successCount / totalProcessed * 100).toFixed(2) : 0\n};\n\nconsole.log('ì›Œí¬í”Œë¡œìš° ì™„ë£Œ ìš”ì•½:', summary);\n\nreturn [{ json: summary }];"
      },
      "id": "workflow-summary",
      "name": "Workflow Summary",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2500,
        300
      ]
    },
    {
      "parameters": {
        "channel": "{{ $env.SLACK_CHANNEL }}",
        "text": "ğŸ“Š ì¼ì¼ ì˜ìƒ ìˆ˜ì§‘ ì™„ë£Œ\\n\\nğŸ“ˆ ì²˜ë¦¬ í˜„í™©:\\n- ì²˜ë¦¬ëœ ì±„ë„: {{ $json.totalChannelsProcessed }}ê°œ\\n- ë¶„ì„ ì‹œì‘ëœ ì˜ìƒ: {{ $json.totalVideosAnalyzed }}ê°œ\\n- ì—ëŸ¬ ë°œìƒ: {{ $json.totalErrors }}ê°œ\\n- ì„±ê³µë¥ : {{ $json.successRate }}%\\n\\nâ° ì™„ë£Œ ì‹œê°„: {{ $json.workflowEndTime }}",
        "otherOptions": {}
      },
      "id": "final-notification",
      "name": "Send Final Summary",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [
        2700,
        300
      ]
    }
  ],
  "connections": {
    "Daily 7AM Trigger": {
      "main": [
        [
          {
            "node": "Workflow Initialization",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Workflow Initialization": {
      "main": [
        [
          {
            "node": "Read Channel List",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Channel List": {
      "main": [
        [
          {
            "node": "Process Channel Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Channel Data": {
      "main": [
        [
          {
            "node": "Loop Over Channels",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Channels": {
      "main": [
        [
          {
            "node": "Fetch RSS Feed",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Workflow Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch RSS Feed": {
      "main": [
        [
          {
            "node": "Filter New Videos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Filter New Videos": {
      "main": [
        [
          {
            "node": "Check New Videos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check New Videos": {
      "main": [
        [
          {
            "node": "Trigger Python Analysis",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Loop Over Channels",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Python Analysis": {
      "main": [
        [
          {
            "node": "Log Analysis Request",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Handle Analysis Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Analysis Request": {
      "main": [
        [
          {
            "node": "Notify Analysis Started",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notify Analysis Started": {
      "main": [
        [
          {
            "node": "Loop Over Channels",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Analysis Error": {
      "main": [
        [
          {
            "node": "Notify Analysis Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notify Analysis Error": {
      "main": [
        [
          {
            "node": "Loop Over Channels",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Workflow Summary": {
      "main": [
        [
          {
            "node": "Send Final Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-06-23T21:35:00.000Z",
  "updatedAt": "2025-06-23T21:35:00.000Z",
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": {
      "id": "error-workflow"
    }
  },
  "staticData": {},
  "tags": ["automation", "video-collection", "daily"]
}