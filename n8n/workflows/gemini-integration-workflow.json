{
  "name": "Gemini API Integration Workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "gemini-analysis",
        "options": {
          "noResponseBody": false
        }
      },
      "id": "gemini-webhook",
      "name": "Gemini Analysis Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [300, 300],
      "webhookId": "gemini-analysis"
    },
    {
      "parameters": {
        "jsCode": "// Gemini API ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ\nconst input = $json;\n\n// ÌïÑÏàò ÌååÎùºÎØ∏ÌÑ∞ Í≤ÄÏ¶ù\nif (!input.text && !input.transcript) {\n  throw new Error('Î∂ÑÏÑùÌï† ÌÖçÏä§Ìä∏ ÎòêÎäî Ìä∏ÎûúÏä§ÌÅ¨Î¶ΩÌä∏Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§');\n}\n\n// Î∂ÑÏÑùÌï† ÌÖçÏä§Ìä∏ Ï§ÄÎπÑ\nconst analysisText = input.text || input.transcript;\nconst analysisType = input.analysis_type || 'product_detection';\n\n// Gemini API ÌîÑÎ°¨ÌîÑÌä∏ ÏÑ§Ï†ï\nlet prompt = '';\n\nswitch (analysisType) {\n  case 'product_detection':\n    prompt = `Îã§Ïùå ÌÖçÏä§Ìä∏ÏóêÏÑú Ï†úÌíà, Î∏åÎûúÎìú, ÎòêÎäî PPL Í¥ÄÎ†® ÎÇ¥Ïö©ÏùÑ Î∂ÑÏÑùÌïòÏÑ∏Ïöî:\n\n${analysisText}\n\nÎã§Ïùå JSON ÌòïÏãùÏúºÎ°ú ÏùëÎãµÌï¥Ï£ºÏÑ∏Ïöî:\n{\n  \"products\": [\n    {\n      \"product_name\": \"Ï†úÌíàÎ™Ö\",\n      \"brand\": \"Î∏åÎûúÎìúÎ™Ö\",\n      \"category\": \"Ïπ¥ÌÖåÍ≥†Î¶¨\",\n      \"confidence\": 0.95,\n      \"context\": \"Ïñ∏Í∏âÎêú Îß•ÎùΩ\",\n      \"sentiment\": \"positive/neutral/negative\",\n      \"is_sponsored\": true/false\n    }\n  ],\n  \"summary\": \"Ï†ÑÏ≤¥ Î∂ÑÏÑù ÏöîÏïΩ\",\n  \"monetization_potential\": {\n    \"score\": 85,\n    \"reasons\": [\"Í∏çÏ†ïÏ†Å Ïñ∏Í∏â\", \"ÏûêÏó∞Ïä§Îü¨Ïö¥ Ï∂îÏ≤ú\"]\n  }\n}`;\n    break;\n    \n  case 'sentiment_analysis':\n    prompt = `Îã§Ïùå ÌÖçÏä§Ìä∏Ïùò Í∞êÏ†ïÍ≥º ÌÜ§ÏùÑ Î∂ÑÏÑùÌïòÏÑ∏Ïöî:\n\n${analysisText}\n\nJSON ÌòïÏãùÏúºÎ°ú ÏùëÎãµ:\n{\n  \"overall_sentiment\": \"positive/neutral/negative\",\n  \"sentiment_score\": 0.85,\n  \"emotions\": [\"excitement\", \"enthusiasm\"],\n  \"tone\": \"casual/formal/promotional\",\n  \"key_phrases\": [\"ÌïµÏã¨ Íµ¨Î¨∏Îì§\"],\n  \"analysis\": \"ÏÉÅÏÑ∏ Î∂ÑÏÑù ÎÇ¥Ïö©\"\n}`;\n    break;\n    \n  case 'content_summary':\n    prompt = `Îã§Ïùå ÏΩòÌÖêÏ∏†Î•º ÏöîÏïΩÌïòÍ≥† ÌïµÏã¨ ÎÇ¥Ïö©ÏùÑ Ï∂îÏ∂úÌïòÏÑ∏Ïöî:\n\n${analysisText}\n\nJSON ÌòïÏãùÏúºÎ°ú ÏùëÎãµ:\n{\n  \"summary\": \"ÎÇ¥Ïö© ÏöîÏïΩ\",\n  \"key_topics\": [\"Ï£ºÏöî Ï£ºÏ†úÎì§\"],\n  \"timestamps\": [],\n  \"highlights\": [\"ÌïòÏù¥ÎùºÏù¥Ìä∏ ÎÇ¥Ïö©\"],\n  \"content_type\": \"Î¶¨Î∑∞/Ïñ∏Î∞ïÏã±/ÏùºÏÉÅ/Í∏∞ÌÉÄ\"\n}`;\n    break;\n    \n  default:\n    prompt = `Îã§Ïùå ÌÖçÏä§Ìä∏Î•º Î∂ÑÏÑùÌïòÏÑ∏Ïöî:\n\n${analysisText}`;\n}\n\n// Gemini API ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞ Íµ¨ÏÑ±\nconst geminiRequest = {\n  contents: [{\n    parts: [{\n      text: prompt\n    }]\n  }],\n  generationConfig: {\n    temperature: 0.1,\n    topK: 40,\n    topP: 0.95,\n    maxOutputTokens: 2048,\n  },\n  safetySettings: [\n    {\n      category: \"HARM_CATEGORY_HARASSMENT\",\n      threshold: \"BLOCK_MEDIUM_AND_ABOVE\"\n    },\n    {\n      category: \"HARM_CATEGORY_HATE_SPEECH\",\n      threshold: \"BLOCK_MEDIUM_AND_ABOVE\"\n    },\n    {\n      category: \"HARM_CATEGORY_SEXUALLY_EXPLICIT\",\n      threshold: \"BLOCK_MEDIUM_AND_ABOVE\"\n    },\n    {\n      category: \"HARM_CATEGORY_DANGEROUS_CONTENT\",\n      threshold: \"BLOCK_MEDIUM_AND_ABOVE\"\n    }\n  ]\n};\n\nreturn [{\n  json: {\n    ...geminiRequest,\n    analysisType: analysisType,\n    originalInput: input,\n    requestTime: new Date().toISOString()\n  }\n}];"
      },
      "id": "prepare-gemini-request",
      "name": "Prepare Gemini Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key={{ $env.GEMINI_API_KEY }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "contents",
              "value": "={{ JSON.stringify($json.contents) }}"
            },
            {
              "name": "generationConfig",
              "value": "={{ JSON.stringify($json.generationConfig) }}"
            },
            {
              "name": "safetySettings",
              "value": "={{ JSON.stringify($json.safetySettings) }}"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "call-gemini-api",
      "name": "Call Gemini API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [700, 300]
    },
    {
      "parameters": {
        "jsCode": "// Gemini API ÏùëÎãµ ÌååÏã± Î∞è Ï†ïÎ¶¨\nconst response = $json;\nconst requestData = $('Prepare Gemini Request').item.json;\n\n// API ÏóêÎü¨ Ï≤¥ÌÅ¨\nif (response.error) {\n  throw new Error(`Gemini API ÏóêÎü¨: ${response.error.message}`);\n}\n\n// ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú\nconst candidates = response.candidates || [];\nif (candidates.length === 0) {\n  throw new Error('Gemini APIÏóêÏÑú ÏùëÎãµÏùÑ Î∞õÏßÄ Î™ªÌñàÏäµÎãàÎã§');\n}\n\nconst content = candidates[0].content;\nconst generatedText = content.parts[0].text;\n\n// JSON ÏùëÎãµ ÌååÏã± ÏãúÎèÑ\nlet parsedResult = null;\ntry {\n  // JSON Î∂ÄÎ∂ÑÎßå Ï∂îÏ∂ú (ÎßàÌÅ¨Îã§Ïö¥ ÏΩîÎìú Î∏îÎ°ù Ï†úÍ±∞)\n  const jsonMatch = generatedText.match(/```(?:json)?\\s*([\\s\\S]*?)\\s*```/) || \n                   generatedText.match(/{[\\s\\S]*}/);\n  \n  if (jsonMatch) {\n    parsedResult = JSON.parse(jsonMatch[1] || jsonMatch[0]);\n  } else {\n    // JSON ÌòïÏãùÏù¥ ÏïÑÎãå Í≤ΩÏö∞ ÌÖçÏä§Ìä∏ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©\n    parsedResult = { text: generatedText };\n  }\n} catch (e) {\n  console.warn('JSON ÌååÏã± Ïã§Ìå®, ÏõêÎ≥∏ ÌÖçÏä§Ìä∏ ÏÇ¨Ïö©:', e.message);\n  parsedResult = { text: generatedText, parse_error: e.message };\n}\n\n// ÏµúÏ¢Ö Í≤∞Í≥º Íµ¨ÏÑ±\nconst result = {\n  analysis_type: requestData.analysisType,\n  gemini_response: parsedResult,\n  raw_text: generatedText,\n  finish_reason: candidates[0].finishReason,\n  safety_ratings: candidates[0].safetyRatings,\n  usage_metadata: response.usageMetadata,\n  request_time: requestData.requestTime,\n  response_time: new Date().toISOString(),\n  success: true\n};\n\nconsole.log('Gemini Î∂ÑÏÑù ÏôÑÎ£å:', result.analysis_type);\n\nreturn [{ json: result }];"
      },
      "id": "process-gemini-response",
      "name": "Process Gemini Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "is-product-detection",
              "leftValue": "={{ $json.analysis_type }}",
              "rightValue": "product_detection",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-analysis-type",
      "name": "Check Analysis Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1100, 300]
    },
    {
      "parameters": {
        "jsCode": "// Ï†úÌíà ÌÉêÏßÄ Í≤∞Í≥ºÎ•º Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÌòïÏãùÏúºÎ°ú Î≥ÄÌôò\nconst analysisResult = $json;\nconst products = analysisResult.gemini_response.products || [];\nconst monetization = analysisResult.gemini_response.monetization_potential || {};\n\n// Í∞Å Ï†úÌíàÏóê ÎåÄÌïú ÌõÑÎ≥¥ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±\nconst candidates = products.map((product, index) => {\n  return {\n    id: `candidate_${Date.now()}_${index}`,\n    source_info: {\n      video_id: analysisResult.originalInput?.video_id || 'unknown',\n      video_url: analysisResult.originalInput?.video_url || '',\n      celebrity_name: analysisResult.originalInput?.celebrity_name || 'Unknown',\n      video_title: analysisResult.originalInput?.video_title || '',\n      analysis_timestamp: analysisResult.response_time\n    },\n    candidate_info: {\n      product_name_ai: product.product_name,\n      brand_name: product.brand,\n      category: product.category,\n      confidence_score: product.confidence,\n      context: product.context,\n      sentiment: product.sentiment,\n      is_sponsored: product.is_sponsored,\n      monetization_score: monetization.score || 0,\n      hook_sentence: `${product.brand} ${product.product_name}ÏúºÎ°ú ${product.context}`\n    },\n    status_info: {\n      current_status: 'needs_review',\n      ai_recommendation: monetization.score > 70 ? 'approve' : 'review',\n      confidence: product.confidence\n    },\n    gemini_analysis: {\n      raw_response: analysisResult.gemini_response,\n      finish_reason: analysisResult.finish_reason,\n      usage_metadata: analysisResult.usage_metadata\n    },\n    created_at: new Date().toISOString()\n  };\n});\n\nconsole.log(`Ï†úÌíà ÌÉêÏßÄ ÏôÑÎ£å: ${candidates.length}Í∞ú ÌõÑÎ≥¥ ÏÉùÏÑ±`);\n\nreturn candidates.map(candidate => ({ json: candidate }));"
      },
      "id": "format-product-candidates",
      "name": "Format Product Candidates",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1300, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.PYTHON_ANALYSIS_ENDPOINT }}/candidates/save",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.ANALYSIS_API_KEY }}"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "candidate",
              "value": "={{ JSON.stringify($json) }}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "save-to-database",
      "name": "Save to Database",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1500, 200]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "resource": "sheet",
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "{{ $env.GOOGLE_SHEET_ID }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Analysis Results",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Analysis Type": "={{ $json.analysis_type }}",
            "Response Time": "={{ $json.response_time }}",
            "Success": "={{ $json.success }}",
            "Token Usage": "={{ $json.usage_metadata ? JSON.stringify($json.usage_metadata) : 'N/A' }}",
            "Summary": "={{ $json.gemini_response.summary || $json.gemini_response.text || 'No summary' }}"
          }
        },
        "options": {}
      },
      "id": "log-to-sheets",
      "name": "Log to Google Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [1300, 400]
    },
    {
      "parameters": {
        "jsCode": "// ÏóêÎü¨ Ï≤òÎ¶¨ Î∞è Î°úÍπÖ\nconst error = $json;\nconst requestData = $('Prepare Gemini Request').item.json;\n\nconsole.error('Gemini API Ìò∏Ï∂ú Ïã§Ìå®:', error);\n\n// ÏóêÎü¨ Ï†ïÎ≥¥ Íµ¨ÏÑ±\nconst errorInfo = {\n  error: true,\n  error_message: error.message || 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò',\n  error_type: 'gemini_api_error',\n  request_data: requestData,\n  timestamp: new Date().toISOString(),\n  analysis_type: requestData.analysisType || 'unknown'\n};\n\nreturn [{ json: errorInfo }];"
      },
      "id": "handle-error",
      "name": "Handle Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 500]
    },
    {
      "parameters": {
        "channel": "{{ $env.SLACK_CHANNEL }}",
        "text": "‚ùå Gemini API Î∂ÑÏÑù Ïã§Ìå®\\n\\nüí• ÏóêÎü¨: {{ $json.error_message }}\\nüìä Î∂ÑÏÑù ÌÉÄÏûÖ: {{ $json.analysis_type }}\\n‚è∞ ÏãúÍ∞Ñ: {{ $json.timestamp }}\\n\\nüîß Ïö¥ÏòÅÏûê ÌôïÏù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.",
        "otherOptions": {}
      },
      "id": "notify-error",
      "name": "Notify Error",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [1100, 500]
    }
  ],
  "connections": {
    "Gemini Analysis Webhook": {
      "main": [
        [
          {
            "node": "Prepare Gemini Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Gemini Request": {
      "main": [
        [
          {
            "node": "Call Gemini API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Gemini API": {
      "main": [
        [
          {
            "node": "Process Gemini Response",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "Handle Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Gemini Response": {
      "main": [
        [
          {
            "node": "Check Analysis Type",
            "type": "main",
            "index": 0
          },
          {
            "node": "Log to Google Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Analysis Type": {
      "main": [
        [
          {
            "node": "Format Product Candidates",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "Format Product Candidates": {
      "main": [
        [
          {
            "node": "Save to Database",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Error": {
      "main": [
        [
          {
            "node": "Notify Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-06-26T01:00:00.000Z",
  "updatedAt": "2025-06-26T01:00:00.000Z",
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": {},
  "tags": ["gemini", "ai-analysis", "product-detection", "google-sheets"]
}