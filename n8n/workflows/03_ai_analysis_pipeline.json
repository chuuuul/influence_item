{
  "name": "03. AI Analysis Pipeline",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "trigger-ai-analysis",
        "options": {
          "noResponseBody": false
        }
      },
      "id": "analysis-trigger",
      "name": "AI Analysis Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [300, 300],
      "webhookId": "ai-analysis-trigger"
    },
    {
      "parameters": {
        "jsCode": "// AI 분석 파라미터 설정 및 검증\nconst triggerData = $input.all()[0].json;\n\n// 필수 파라미터 검증\nif (!triggerData.video_url) {\n  throw new Error('video_url is required');\n}\n\n// 분석 설정\nconst analysisParams = {\n  video_url: triggerData.video_url,\n  video_id: triggerData.video_id || extractVideoId(triggerData.video_url),\n  channel_info: triggerData.channel_info || {},\n  priority: triggerData.priority || 'normal',\n  analysis_type: triggerData.analysis_type || 'full', // full, quick, audio_only\n  session_id: `analysis_${Date.now()}`,\n  start_time: new Date().toISOString(),\n  \n  // AI 2-Pass 파이프라인 설정\n  whisper_model: 'small', // PRD 요구사항: Whisper small 모델\n  gemini_model: '2.5-flash', // PRD 요구사항: Gemini 2.5 Flash\n  enable_ocr: true,\n  enable_object_detection: true,\n  enable_ppl_detection: true,\n  enable_monetization_check: true,\n  \n  // 점수 가중치 (PRD 공식)\n  scoring_weights: {\n    sentiment_score: 0.50,\n    endorsement_score: 0.35,\n    influencer_score: 0.15\n  }\n};\n\n// 비디오 ID 추출 함수\nfunction extractVideoId(url) {\n  const match = url.match(/(?:youtube\\.com\\/watch\\?v=|youtu\\.be\\/)([a-zA-Z0-9_-]+)/);\n  return match ? match[1] : null;\n}\n\nconsole.log('AI 분석 시작:', analysisParams);\n\nreturn [{ json: analysisParams }];"
      },
      "id": "setup-analysis-params",
      "name": "Setup Analysis Parameters",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [500, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/analyze/whisper",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "video_url",
              "value": "={{ $json.video_url }}"
            },
            {
              "name": "video_id",
              "value": "={{ $json.video_id }}"
            },
            {
              "name": "model",
              "value": "{{ $json.whisper_model }}"
            },
            {
              "name": "session_id",
              "value": "={{ $json.session_id }}"
            }
          ]
        },
        "options": {
          "timeout": 300000
        }
      },
      "id": "step1-whisper-analysis",
      "name": "Step 1: Whisper Audio Analysis",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [700, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/analyze/gemini-first-pass",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "transcript",
              "value": "={{ JSON.stringify($json.transcript) }}"
            },
            {
              "name": "video_id",
              "value": "={{ $('Setup Analysis Parameters').item.json.video_id }}"
            },
            {
              "name": "session_id",
              "value": "={{ $('Setup Analysis Parameters').item.json.session_id }}"
            },
            {
              "name": "model",
              "value": "{{ $('Setup Analysis Parameters').item.json.gemini_model }}"
            }
          ]
        },
        "options": {
          "timeout": 120000
        }
      },
      "id": "step2-gemini-first-pass",
      "name": "Step 2: Gemini First Pass (탐색)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-candidate-segments",
              "leftValue": "={{ $json.candidate_segments && $json.candidate_segments.length }}",
              "rightValue": "0",
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-candidate-segments",
      "name": "Check If Candidate Segments Found",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1100, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/analyze/visual",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "video_url",
              "value": "={{ $('Setup Analysis Parameters').item.json.video_url }}"
            },
            {
              "name": "candidate_segments",
              "value": "={{ JSON.stringify($json.candidate_segments) }}"
            },
            {
              "name": "session_id",
              "value": "={{ $('Setup Analysis Parameters').item.json.session_id }}"
            },
            {
              "name": "enable_ocr",
              "value": "{{ $('Setup Analysis Parameters').item.json.enable_ocr }}"
            },
            {
              "name": "enable_object_detection",
              "value": "{{ $('Setup Analysis Parameters').item.json.enable_object_detection }}"
            }
          ]
        },
        "options": {
          "timeout": 300000
        }
      },
      "id": "step3-visual-analysis",
      "name": "Step 3: Visual Analysis (OCR + Object Detection)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1300, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/analyze/gemini-second-pass",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "audio_data",
              "value": "={{ JSON.stringify($('Step 2: Gemini First Pass (탐색)').item.json) }}"
            },
            {
              "name": "visual_data",
              "value": "={{ JSON.stringify($json) }}"
            },
            {
              "name": "video_id",
              "value": "={{ $('Setup Analysis Parameters').item.json.video_id }}"
            },
            {
              "name": "session_id",
              "value": "={{ $('Setup Analysis Parameters').item.json.session_id }}"
            },
            {
              "name": "channel_info",
              "value": "={{ JSON.stringify($('Setup Analysis Parameters').item.json.channel_info) }}"
            }
          ]
        },
        "options": {
          "timeout": 120000
        }
      },
      "id": "step4-gemini-second-pass",
      "name": "Step 4: Gemini Second Pass (종합)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1500, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/analyze/ppl-filter",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "analysis_result",
              "value": "={{ JSON.stringify($json) }}"
            },
            {
              "name": "session_id",
              "value": "={{ $('Setup Analysis Parameters').item.json.session_id }}"
            }
          ]
        },
        "options": {
          "timeout": 60000
        }
      },
      "id": "step5-ppl-filtering",
      "name": "Step 5: PPL Content Filtering",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1700, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/analyze/monetization",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "products",
              "value": "={{ JSON.stringify($json.products || []) }}"
            },
            {
              "name": "session_id",
              "value": "={{ $('Setup Analysis Parameters').item.json.session_id }}"
            }
          ]
        },
        "options": {
          "timeout": 60000
        }
      },
      "id": "step6-monetization-check",
      "name": "Step 6: Monetization Verification (Coupang)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1900, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/analyze/scoring",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "analysis_data",
              "value": "={{ JSON.stringify($json) }}"
            },
            {
              "name": "scoring_weights",
              "value": "={{ JSON.stringify($('Setup Analysis Parameters').item.json.scoring_weights) }}"
            },
            {
              "name": "session_id",
              "value": "={{ $('Setup Analysis Parameters').item.json.session_id }}"
            }
          ]
        },
        "options": {
          "timeout": 60000
        }
      },
      "id": "step7-scoring",
      "name": "Step 7: Attractiveness Scoring",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2100, 200]
    },
    {
      "parameters": {
        "jsCode": "// 최종 분석 결과 처리 및 정리\nconst finalResult = $json;\nconst setupData = $('Setup Analysis Parameters').item.json;\n\n// 분석 완료 데이터 구성\nconst processedResult = {\n  session_id: setupData.session_id,\n  video_url: setupData.video_url,\n  video_id: setupData.video_id,\n  channel_info: setupData.channel_info,\n  start_time: setupData.start_time,\n  end_time: new Date().toISOString(),\n  execution_time: ((new Date() - new Date(setupData.start_time)) / 1000).toFixed(1),\n  \n  // 분석 결과\n  analysis_result: finalResult,\n  total_products: finalResult.products ? finalResult.products.length : 0,\n  monetizable_products: finalResult.monetizable_products ? finalResult.monetizable_products.length : 0,\n  filtered_products: finalResult.filtered_products ? finalResult.filtered_products.length : 0,\n  \n  // 상태 정보\n  status: 'analysis_complete',\n  success: true,\n  \n  // 타임스탬프\n  completed_at: new Date().toISOString()\n};\n\nconsole.log(`AI 분석 완료: ${processedResult.total_products}개 제품 발견, ${processedResult.monetizable_products}개 수익화 가능`);\n\nreturn [{ json: processedResult }];"
      },
      "id": "finalize-analysis",
      "name": "Finalize Analysis Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2300, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.SLACK_WEBHOOK_URL }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "🤖 AI 분석 완료!"
            },
            {
              "name": "blocks",
              "value": "={{ JSON.stringify([{\"type\": \"header\", \"text\": {\"type\": \"plain_text\", \"text\": \"🤖 AI 분석 완료!\"}}, {\"type\": \"section\", \"fields\": [{\"type\": \"mrkdwn\", \"text\": \"*영상:*\\n<\" + $json.video_url + \"|\" + ($json.channel_info.channel_name || 'Unknown') + \">\"}, {\"type\": \"mrkdwn\", \"text\": \"*발견된 제품:*\\n\" + $json.total_products + \"개\"}, {\"type\": \"mrkdwn\", \"text\": \"*수익화 가능:*\\n\" + $json.monetizable_products + \"개\"}, {\"type\": \"mrkdwn\", \"text\": \"*실행 시간:*\\n\" + $json.execution_time + \"초\"}]}, {\"type\": \"section\", \"text\": {\"type\": \"mrkdwn\", \"text\": \"📊 *분석 파이프라인:*\\n✅ Whisper 음성 분석\\n✅ Gemini 1차 탐색\\n✅ 시각 분석 (OCR + Object)\\n✅ Gemini 2차 종합\\n✅ PPL 필터링\\n✅ 쿠팡 수익화 검증\\n✅ 매력도 스코어링\"}}, {\"type\": \"context\", \"elements\": [{\"type\": \"mrkdwn\", \"text\": \"완료: \" + new Date().toLocaleString('ko-KR') + \" | 세션: \" + $json.session_id}]}]) }}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "notify-analysis-complete",
      "name": "Notify Analysis Complete",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2500, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.SLACK_WEBHOOK_URL }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "😔 AI 분석 완료 - 제품 후보 없음"
            },
            {
              "name": "blocks",
              "value": "={{ JSON.stringify([{\"type\": \"header\", \"text\": {\"type\": \"plain_text\", \"text\": \"😔 AI 분석 완료\"}}, {\"type\": \"section\", \"text\": {\"type\": \"mrkdwn\", \"text\": \"*결과:* 제품 추천 구간을 찾지 못했습니다.\\n\\n*분석된 영상:*\\n<\" + $('Setup Analysis Parameters').item.json.video_url + \"|\" + ($('Setup Analysis Parameters').item.json.channel_info.channel_name || 'Unknown') + \">\\n\\n*세션 ID:* \" + $('Setup Analysis Parameters').item.json.session_id}}, {\"type\": \"section\", \"text\": {\"type\": \"mrkdwn\", \"text\": \"💡 *가능한 원인:*\\n• 제품 언급이 없는 영상\\n• 추천 맥락이 명확하지 않음\\n• 음성 인식 품질 문제\"}}, {\"type\": \"context\", \"elements\": [{\"type\": \"mrkdwn\", \"text\": \"완료: \" + new Date().toLocaleString('ko-KR') + \" | 시스템: AI 분석 파이프라인\"}]}]) }}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "notify-no-products",
      "name": "Notify No Products Found",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1300, 400]
    }
  ],
  "connections": {
    "AI Analysis Trigger": {
      "main": [
        [
          {
            "node": "Setup Analysis Parameters",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setup Analysis Parameters": {
      "main": [
        [
          {
            "node": "Step 1: Whisper Audio Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 1: Whisper Audio Analysis": {
      "main": [
        [
          {
            "node": "Step 2: Gemini First Pass (탐색)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 2: Gemini First Pass (탐색)": {
      "main": [
        [
          {
            "node": "Check If Candidate Segments Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check If Candidate Segments Found": {
      "main": [
        [
          {
            "node": "Step 3: Visual Analysis (OCR + Object Detection)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Notify No Products Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 3: Visual Analysis (OCR + Object Detection)": {
      "main": [
        [
          {
            "node": "Step 4: Gemini Second Pass (종합)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 4: Gemini Second Pass (종합)": {
      "main": [
        [
          {
            "node": "Step 5: PPL Content Filtering",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 5: PPL Content Filtering": {
      "main": [
        [
          {
            "node": "Step 6: Monetization Verification (Coupang)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 6: Monetization Verification (Coupang)": {
      "main": [
        [
          {
            "node": "Step 7: Attractiveness Scoring",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Step 7: Attractiveness Scoring": {
      "main": [
        [
          {
            "node": "Finalize Analysis Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Finalize Analysis Results": {
      "main": [
        [
          {
            "node": "Notify Analysis Complete",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "createdAt": "2025-06-25T07:00:00.000Z",
  "updatedAt": "2025-06-25T07:00:00.000Z",
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": {},
  "tags": []
}