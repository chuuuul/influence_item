{
  "name": "Analysis Result Notification Workflow",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "analysis-complete",
        "options": {
          "noResponseBody": false
        }
      },
      "id": "analysis-webhook",
      "name": "Analysis Complete Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        300,
        300
      ],
      "webhookId": "analysis-result"
    },
    {
      "parameters": {
        "jsCode": "// ë¶„ì„ ì™„ë£Œ ê²°ê³¼ ë°ì´í„° íŒŒì‹±\nconst resultData = $json;\n\nconsole.log('ë¶„ì„ ì™„ë£Œ ì•Œë¦¼ ìˆ˜ì‹ :', resultData.job_id);\n\n// ê²°ê³¼ ë°ì´í„° êµ¬ì¡° íŒŒì‹±\nconst analysisResult = {\n  jobId: resultData.job_id,\n  videoTitle: resultData.video_title,\n  channelName: resultData.channel_name,\n  videoUrl: resultData.video_url,\n  analysisStatus: resultData.status, // 'completed', 'failed', 'partial'\n  candidatesFound: resultData.candidates_found || 0,\n  approvedCandidates: resultData.approved_candidates || 0,\n  rejectedCandidates: resultData.rejected_candidates || 0,\n  avgScore: resultData.avg_score || 0,\n  topProduct: resultData.top_product || null,\n  processingTime: resultData.processing_time_seconds || 0,\n  errorMessage: resultData.error_message || null,\n  timestamp: new Date().toISOString(),\n  dashboardUrl: `${$env.DASHBOARD_BASE_URL}/details/${resultData.job_id}`\n};\n\n// ì„±ê³µë¥  ê³„ì‚°\nconst totalCandidates = analysisResult.candidatesFound;\nconst approvalRate = totalCandidates > 0 ? \n  (analysisResult.approvedCandidates / totalCandidates * 100).toFixed(1) : 0;\n\nreturn [{\n  json: {\n    ...analysisResult,\n    approvalRate: approvalRate,\n    isSuccess: analysisResult.analysisStatus === 'completed' && analysisResult.candidatesFound > 0,\n    hasError: analysisResult.analysisStatus === 'failed'\n  }\n}];"
      },
      "id": "parse-analysis-result",
      "name": "Parse Analysis Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        500,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "is-success",
              "leftValue": "={{ $json.isSuccess }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-analysis-status",
      "name": "Check Analysis Status",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        700,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// ì„±ê³µì ì¸ ë¶„ì„ ê²°ê³¼ Slack ë©”ì‹œì§€ êµ¬ì„±\nconst result = $json;\n\n// ì´ëª¨ì§€ì™€ í•¨ê»˜ ìƒíƒœ í‘œì‹œ\nconst statusEmoji = result.approvalRate > 50 ? 'ğŸ‰' : result.approvalRate > 20 ? 'ğŸ‘' : 'ğŸ”';\nconst scoreEmoji = result.avgScore > 80 ? 'ğŸ”¥' : result.avgScore > 60 ? 'â­' : 'ğŸ“Š';\n\n// ì£¼ìš” ì œí’ˆ ì •ë³´\nconst topProductText = result.topProduct ? \n  `\\nğŸ† *ìµœê³  ì ìˆ˜ ì œí’ˆ:* ${result.topProduct.name} (${result.topProduct.score}ì )` : '';\n\n// Slack ë©”ì‹œì§€ êµ¬ì„±\nconst slackMessage = {\n  channel: $env.SLACK_CHANNEL,\n  blocks: [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": `${statusEmoji} ì˜ìƒ ë¶„ì„ ì™„ë£Œ!`\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": `*ğŸ“º ì±„ë„:*\\n${result.channelName}`\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": `*ğŸ¬ ì˜ìƒ:*\\n${result.videoTitle}`\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": `*ğŸ¯ í›„ë³´ ìˆ˜:*\\nì´ ${result.candidatesFound}ê°œ ë°œê²¬`\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": `*âœ… ìŠ¹ì¸ë¥ :*\\n${result.approvalRate}%`\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": `*${scoreEmoji} í‰ê·  ì ìˆ˜:*\\n${result.avgScore}ì `\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": `*â±ï¸ ì²˜ë¦¬ ì‹œê°„:*\\n${result.processingTime}ì´ˆ`\n        }\n      ]\n    }\n  ],\n  attachments: [\n    {\n      \"color\": result.approvalRate > 50 ? \"good\" : result.approvalRate > 20 ? \"warning\" : \"#439FE0\",\n      \"fields\": [\n        {\n          \"title\": \"ìƒì„¸ ê²°ê³¼\",\n          \"value\": `ìŠ¹ì¸: ${result.approvedCandidates}ê°œ\\nê±°ì ˆ: ${result.rejectedCandidates}ê°œ${topProductText}`,\n          \"short\": false\n        }\n      ],\n      \"actions\": [\n        {\n          \"type\": \"button\",\n          \"text\": \"ğŸ” ëŒ€ì‹œë³´ë“œì—ì„œ ë³´ê¸°\",\n          \"url\": result.dashboardUrl\n        },\n        {\n          \"type\": \"button\",\n          \"text\": \"ğŸ¬ ì˜ìƒ ë³´ê¸°\",\n          \"url\": result.videoUrl\n        }\n      ]\n    }\n  ]\n};\n\nreturn [{ json: slackMessage }];"
      },
      "id": "format-success-message",
      "name": "Format Success Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// ì‹¤íŒ¨ ë˜ëŠ” ë‚®ì€ ì„±ê³¼ ë¶„ì„ ê²°ê³¼ Slack ë©”ì‹œì§€ êµ¬ì„±\nconst result = $json;\n\n// ìƒíƒœì— ë”°ë¥¸ ì´ëª¨ì§€ ë° ìƒ‰ìƒ\nlet statusEmoji, color, statusText;\nif (result.hasError) {\n  statusEmoji = 'âŒ';\n  color = 'danger';\n  statusText = 'ë¶„ì„ ì‹¤íŒ¨';\n} else if (result.candidatesFound === 0) {\n  statusEmoji = 'ğŸ”';\n  color = 'warning';\n  statusText = 'í›„ë³´ ì—†ìŒ';\n} else {\n  statusEmoji = 'ğŸ“Š';\n  color = '#439FE0';\n  statusText = 'ë¶„ì„ ì™„ë£Œ';\n}\n\n// ì—ëŸ¬ ì •ë³´\nconst errorText = result.errorMessage ? \n  `\\nğŸ’¥ *ì—ëŸ¬:* ${result.errorMessage}` : '';\n\n// Slack ë©”ì‹œì§€ êµ¬ì„±\nconst slackMessage = {\n  channel: $env.SLACK_CHANNEL,\n  blocks: [\n    {\n      \"type\": \"header\",\n      \"text\": {\n        \"type\": \"plain_text\",\n        \"text\": `${statusEmoji} ${statusText}`\n      }\n    },\n    {\n      \"type\": \"section\",\n      \"fields\": [\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": `*ğŸ“º ì±„ë„:*\\n${result.channelName}`\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": `*ğŸ¬ ì˜ìƒ:*\\n${result.videoTitle}`\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": `*ğŸ¯ í›„ë³´ ìˆ˜:*\\n${result.candidatesFound}ê°œ`\n        },\n        {\n          \"type\": \"mrkdwn\",\n          \"text\": `*â±ï¸ ì²˜ë¦¬ ì‹œê°„:*\\n${result.processingTime}ì´ˆ`\n        }\n      ]\n    }\n  ],\n  attachments: [\n    {\n      \"color\": color,\n      \"fields\": [\n        {\n          \"title\": \"ìƒì„¸ ì •ë³´\",\n          \"value\": `ìƒíƒœ: ${result.analysisStatus}\\nì‘ì—… ID: ${result.jobId}${errorText}`,\n          \"short\": false\n        }\n      ],\n      \"actions\": [\n        {\n          \"type\": \"button\",\n          \"text\": \"ğŸ¬ ì˜ìƒ í™•ì¸\",\n          \"url\": result.videoUrl\n        }\n      ]\n    }\n  ]\n};\n\nreturn [{ json: slackMessage }];"
      },
      "id": "format-failure-message",
      "name": "Format Failure Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        400
      ]
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "send",
        "channel": "={{ $json.channel }}",
        "blocksUi": "={{ JSON.stringify($json.blocks) }}",
        "attachments": "={{ JSON.stringify($json.attachments) }}",
        "otherOptions": {}\n      },
      "id": "send-slack-notification",
      "name": "Send Slack Notification",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.1,
      "position": [
        1100,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// ì•Œë¦¼ ë°œì†¡ ê²°ê³¼ ë¡œê¹…\nconst slackResult = $json;\nconst originalData = $('Parse Analysis Result').item.json;\n\nconsole.log(`Slack ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ: ${originalData.jobId}`);\nconsole.log(`ë©”ì‹œì§€ íƒ€ì„ìŠ¤íƒ¬í”„: ${slackResult.ts}`);\n\nreturn [{\n  json: {\n    jobId: originalData.jobId,\n    notificationSent: true,\n    slackMessageTs: slackResult.ts,\n    channel: slackResult.channel,\n    sentAt: new Date().toISOString()\n  }\n}];"
      },
      "id": "log-notification-sent",
      "name": "Log Notification Sent",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1300,
        300
      ]
    }
  ],
  "connections": {
    "Analysis Complete Webhook": {
      "main": [
        [
          {
            "node": "Parse Analysis Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Analysis Result": {
      "main": [
        [
          {
            "node": "Check Analysis Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Analysis Status": {
      "main": [
        [
          {
            "node": "Format Success Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Failure Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Success Message": {
      "main": [
        [
          {
            "node": "Send Slack Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Failure Message": {
      "main": [
        [
          {
            "node": "Send Slack Notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Slack Notification": {
      "main": [
        [
          {
            "node": "Log Notification Sent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-06-23T21:50:00.000Z",
  "updatedAt": "2025-06-23T21:50:00.000Z",
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": {
      "id": "error-workflow"
    }
  },
  "staticData": {},
  "tags": ["analysis", "slack", "notification", "results"]
}