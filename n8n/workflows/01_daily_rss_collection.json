{
  "name": "01. Daily RSS Feed Collection",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 7 * * *"
            }
          ]
        }
      },
      "id": "daily-cron-7am",
      "name": "Daily Cron (7 AM)",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [300, 300]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "resource": "sheet",
        "operation": "read",
        "documentId": {
          "__rl": true,
          "value": "{{ $env.GOOGLE_SHEETS_SPREADSHEET_ID }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Channel List",
          "mode": "name"
        },
        "options": {
          "range": "A:E"
        }
      },
      "id": "read-channel-list",
      "name": "Read Channel List from Google Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [500, 300]
    },
    {
      "parameters": {
        "jsCode": "// ì±„ë„ ëª©ë¡ì—ì„œ RSS í”¼ë“œ URL ìƒì„± ë° í•„í„°ë§\nconst channelData = $input.all();\nconst rssUrls = [];\n\nfor (const row of channelData) {\n  const channelId = row.json.channel_id;\n  const channelName = row.json.channel_name;\n  const channelType = row.json.channel_type;\n  const status = row.json.status;\n  const celebrityName = row.json.celebrity_name;\n  \n  // í™œì„± ìƒíƒœì¸ ì±„ë„ë§Œ ì²˜ë¦¬\n  if (status === 'active' && channelId) {\n    rssUrls.push({\n      channel_id: channelId,\n      channel_name: channelName,\n      channel_type: channelType,\n      celebrity_name: celebrityName,\n      rss_url: `https://www.youtube.com/feeds/videos.xml?channel_id=${channelId}`\n    });\n  }\n}\n\nconsole.log(`í™œì„± ì±„ë„ ${rssUrls.length}ê°œì˜ RSS í”¼ë“œ ì¤€ë¹„ ì™„ë£Œ`);\n\nreturn rssUrls.map(url => ({ json: url }));"
      },
      "id": "prepare-rss-urls",
      "name": "Prepare RSS Feed URLs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [700, 300]
    },
    {
      "parameters": {
        "url": "={{ $json.rss_url }}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "fetch-rss-feed",
      "name": "Fetch RSS Feed",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [900, 300]
    },
    {
      "parameters": {
        "jsCode": "// RSS XML íŒŒì‹±í•˜ì—¬ ìµœì‹  ì˜ìƒ ì¶”ì¶œ\nconst rssXml = $json.body;\nconst channelInfo = $('Prepare RSS Feed URLs').item.json;\nconst DOMParser = require('xmldom').DOMParser;\n\n// XML íŒŒì‹±\nlet newVideos = [];\ntry {\n  const parser = new DOMParser();\n  const xmlDoc = parser.parseFromString(rssXml, 'text/xml');\n  const entries = xmlDoc.getElementsByTagName('entry');\n  \n  // ì§€ë‚œ 24ì‹œê°„ ë‚´ ì—…ë¡œë“œëœ ì˜ìƒë§Œ í•„í„°ë§\n  const yesterday = new Date();\n  yesterday.setDate(yesterday.getDate() - 1);\n  \n  for (let i = 0; i < Math.min(entries.length, 10); i++) {\n    const entry = entries[i];\n    const videoId = entry.getElementsByTagName('yt:videoId')[0]?.textContent;\n    const title = entry.getElementsByTagName('title')[0]?.textContent;\n    const published = entry.getElementsByTagName('published')[0]?.textContent;\n    const author = entry.getElementsByTagName('author')[0]?.getElementsByTagName('name')[0]?.textContent;\n    \n    if (videoId && title && published) {\n      const publishDate = new Date(published);\n      \n      // 24ì‹œê°„ ë‚´ ì—…ë¡œë“œëœ ì˜ìƒì¸ì§€ í™•ì¸\n      if (publishDate >= yesterday) {\n        // ë¯¸ë””ì–´ ì±„ë„ì˜ ê²½ìš° ì—°ì˜ˆì¸ ì´ë¦„ì´ ì œëª©ì— í¬í•¨ëœ ê²½ìš°ë§Œ\n        let shouldInclude = true;\n        if (channelInfo.channel_type === 'media' && channelInfo.celebrity_name) {\n          shouldInclude = title.toLowerCase().includes(channelInfo.celebrity_name.toLowerCase());\n        }\n        \n        // YouTube Shorts ì œì™¸ (PRD ìš”êµ¬ì‚¬í•­)\n        const isShorts = title.toLowerCase().includes('#shorts') || \n                        title.toLowerCase().includes('shorts') ||\n                        title.includes('ğŸ©³');\n        \n        if (shouldInclude && !isShorts) {\n          newVideos.push({\n            video_id: videoId,\n            video_title: title,\n            video_url: `https://www.youtube.com/watch?v=${videoId}`,\n            channel_id: channelInfo.channel_id,\n            channel_name: channelInfo.channel_name,\n            channel_type: channelInfo.channel_type,\n            celebrity_name: channelInfo.celebrity_name,\n            published_date: published,\n            author: author,\n            discovery_date: new Date().toISOString()\n          });\n        }\n      }\n    }\n  }\n} catch (error) {\n  console.error('RSS íŒŒì‹± ì˜¤ë¥˜:', error);\n}\n\nconsole.log(`${channelInfo.channel_name}: ${newVideos.length}ê°œ ì‹ ê·œ ì˜ìƒ ë°œê²¬`);\n\nreturn newVideos.map(video => ({ json: video }));"
      },
      "id": "parse-rss-feed",
      "name": "Parse RSS Feed for New Videos",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-new-videos",
              "leftValue": "={{ $json.video_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isNotEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-new-videos",
      "name": "Check If New Videos Found",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1300, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.CHANNEL_DISCOVERY_API_URL || 'http://localhost:5001' }}/analyze/video",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "video_url",
              "value": "={{ $json.video_url }}"
            },
            {
              "name": "video_id",
              "value": "={{ $json.video_id }}"
            },
            {
              "name": "channel_info",
              "value": "={{ JSON.stringify({channel_id: $json.channel_id, channel_name: $json.channel_name, channel_type: $json.channel_type, celebrity_name: $json.celebrity_name}) }}"
            },
            {
              "name": "priority",
              "value": "normal"
            }
          ]
        },
        "options": {
          "timeout": 120000
        }
      },
      "id": "trigger-video-analysis",
      "name": "Trigger Video Analysis",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1500, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.SLACK_WEBHOOK_URL }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "ğŸ“º ìƒˆë¡œìš´ ì˜ìƒ ë°œê²¬!"
            },
            {
              "name": "blocks",
              "value": "={{ JSON.stringify([{\"type\": \"header\", \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸ“º ìƒˆë¡œìš´ ì˜ìƒ ë°œê²¬!\"}}, {\"type\": \"section\", \"fields\": [{\"type\": \"mrkdwn\", \"text\": \"*ì±„ë„:*\\n\" + $json.channel_name}, {\"type\": \"mrkdwn\", \"text\": \"*ì—°ì˜ˆì¸:*\\n\" + ($json.celebrity_name || 'N/A')}, {\"type\": \"mrkdwn\", \"text\": \"*ì˜ìƒ ì œëª©:*\\n\" + $json.video_title}, {\"type\": \"mrkdwn\", \"text\": \"*ì—…ë¡œë“œ:*\\n\" + new Date($json.published_date).toLocaleString('ko-KR')}]}, {\"type\": \"section\", \"text\": {\"type\": \"mrkdwn\", \"text\": \"ğŸ”— <\" + $json.video_url + \"|ì˜ìƒ ë³´ê¸°> | ğŸ¤– ë¶„ì„ ì‹œì‘ë¨\"}}, {\"type\": \"context\", \"elements\": [{\"type\": \"mrkdwn\", \"text\": \"ğŸ“… \" + new Date().toLocaleString('ko-KR') + \" | ğŸ¤– ìë™ ìˆ˜ì§‘\"}]}]) }}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "notify-new-video",
      "name": "Notify New Video Found",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1500, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "{{ $env.SLACK_WEBHOOK_URL }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "text",
              "value": "âœ… ì¼ì¼ RSS ìˆ˜ì§‘ ì™„ë£Œ - ìƒˆë¡œìš´ ì˜ìƒ ì—†ìŒ"
            },
            {
              "name": "blocks",
              "value": "={{ JSON.stringify([{\"type\": \"header\", \"text\": {\"type\": \"plain_text\", \"text\": \"âœ… ì¼ì¼ RSS ìˆ˜ì§‘ ì™„ë£Œ\"}}, {\"type\": \"section\", \"text\": {\"type\": \"mrkdwn\", \"text\": \"ğŸ“Š *ê²°ê³¼:* ìƒˆë¡œìš´ ì˜ìƒì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\\n\\nğŸ’¡ *ì°¸ê³ :* ì§€ë‚œ 24ì‹œê°„ ë‚´ ì—…ë¡œë“œëœ ì˜ìƒì´ ì—†ê±°ë‚˜, ì´ë¯¸ ë¶„ì„ ì™„ë£Œëœ ì˜ìƒë“¤ì…ë‹ˆë‹¤.\"}}, {\"type\": \"context\", \"elements\": [{\"type\": \"mrkdwn\", \"text\": \"ğŸ“… \" + new Date().toLocaleString('ko-KR') + \" | ğŸ¤– ìë™ ìˆ˜ì§‘\"}]}]) }}"
            }
          ]
        },
        "options": {
          "timeout": 10000
        }
      },
      "id": "notify-no-videos",
      "name": "Notify No New Videos",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1300, 500]
    }
  ],
  "connections": {
    "Daily Cron (7 AM)": {
      "main": [
        [
          {
            "node": "Read Channel List from Google Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Read Channel List from Google Sheets": {
      "main": [
        [
          {
            "node": "Prepare RSS Feed URLs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare RSS Feed URLs": {
      "main": [
        [
          {
            "node": "Fetch RSS Feed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch RSS Feed": {
      "main": [
        [
          {
            "node": "Parse RSS Feed for New Videos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse RSS Feed for New Videos": {
      "main": [
        [
          {
            "node": "Check If New Videos Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check If New Videos Found": {
      "main": [
        [
          {
            "node": "Trigger Video Analysis",
            "type": "main",
            "index": 0
          },
          {
            "node": "Notify New Video Found",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Notify No New Videos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "createdAt": "2025-06-25T07:00:00.000Z",
  "updatedAt": "2025-06-25T07:00:00.000Z",
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": {},
  "tags": []
}